C51 COMPILER V9.60.7.0   LED_HANDLE                                                        08/08/2025 16:56:36 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_HANDLE
OBJECT MODULE PLACED IN .\Release\Objects\led_handle.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_handle.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\HardWare) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_h
                    -andle.lst) OBJECT(.\Release\Objects\led_handle.obj)

line level    source

   1          #include "led_handle.h"
   2          
   3          // åªèƒ½åˆšä¸Šç”µæ—¶è°ƒç”¨ï¼š
   4          void led_init(void)
   5          {
   6   1          led_all_off();
   7   1      
   8   1          last_led_gear = 0; // èµ‹å€¼ä¸ºåˆå§‹å€¼
   9   1          cur_led_gear_in_charging = 0;
  10   1          led_setting_mode_exit_times_cnt = 0; // æ¸…é™¤è®¾ç½®æ¨¡å¼ä¸‹çš„é€€å‡ºæ—¶é—´è®¡æ—¶
  11   1          flag_is_in_struction_mode = 0;
  12   1      }
  13          
  14          void led_all_off(void)
  15          {
  16   1          LED_1_OFF();
  17   1          LED_2_OFF();
  18   1          LED_3_OFF();
  19   1          LED_4_OFF();
  20   1          LED_5_OFF();
  21   1      }
  22          
  23          // æ¸…é™¤ledæœ‰å…³çš„çŠ¶æ€
  24          void led_status_clear(void)
  25          {
  26   1          led_all_off();
  27   1      
  28   1          // æ¸…ç©ºè®¾ç½®æ¨¡å¼ç›¸å…³çš„å˜é‡
  29   1          flag_is_in_setting_mode = 0;
  30   1          flag_led_setting_mode_exit_times_come = 0;
  31   1          led_setting_mode_exit_times_cnt = 0;
  32   1      
  33   1          // æ¸…ç©ºæŒ‡ç¤ºæ¨¡å¼ç›¸å…³çš„å˜é‡
  34   1          flag_is_in_struction_mode = 0;
  35   1          flag_led_struction_mode_exit_times_come = 0;
  36   1          led_struction_mode_exit_times_cnt = 0;
  37   1      
  38   1          // flag_is_led_off_enable = 0; // ä¸èƒ½åŠ å…¥è¿™å¥ï¼Œå¦‚æœé‡å¤æŒ‰ä¸‹SETæˆ–çº¢è‰²æŒ‰é”®ï¼Œä¼šå¯¼è‡
             -´æ— æ³•å…³æŒ‡ç¤ºç¯
  39   1      }
  40          
  41          /**
  42           * @brief æ›´æ”¹led_mode
  43           *
  44           * @param led_mode
  45           *              ç›¸å…³å®šä¹‰åœ¨ æšä¸¾ç±»å‹ CUR_LED_MODE_XXX ä¸­
  46          
  47           */
  48          void led_mode_alter(u8 led_mode)
  49          {
  50   1          led_all_off();
  51   1      
  52   1          cur_led_mode = led_mode;
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        08/08/2025 16:56:36 PAGE 2   

  53   1      }
  54          
  55          /**
  56           * @brief åœ¨è®¾ç½®æ¨¡å¼ï¼Œè®¾ç½®åˆå§‹æ”¾ç”µæŒ¡ä½æˆ–æ”¾ç”µé€Ÿç‡
  57           *          å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­ å½“å‰ æ˜¯å¦å¤„äºè®¾ç½®æ¨¡å¼
  58           *
  59           * @param set_led_mode
  60           *          CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE è¦è®¾ç½®çš„æ˜¯åˆå§‹æ”¾ç”µæŒ¡ä½
  61           *          CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE     è¦è®¾ç½®çš„æ˜¯æ”¾ç”µé€Ÿç‡
  62           * @param val åˆå§‹æ”¾ç”µæŒ¡ä½ æˆ– æ”¾ç”µé€Ÿç‡å¯¹åº”çš„å€¼ï¼ˆéœ€è¦æ³¨æ„ä¸èƒ½è¶…è¿‡èŒƒå›´ï¼‰
  63           */
  64          void set_led_mode_status(u8 set_led_mode, u8 val)
  65          {
  66   1          // å¦‚æœåœ¨è®¾ç½®æ¨¡å¼ï¼Œæ‰ä¼šè¿›å…¥
  67   1          if (flag_is_in_setting_mode)
  68   1          {
  69   2              if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE == set_led_mode)
  70   2              {
  71   3                  cur_initial_discharge_gear = val;
  72   3      
  73   3                  // è®¾ç½®äº†åˆå§‹æŒ¡ä½ä¹‹åï¼Œæ›´æ–°å½“å‰ä¸»ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  74   3                  cur_light_pwm_duty_val = light_pwm_duty_init_val_table[cur_initial_discharge_gear - 1];
  75   3              }
  76   2              else // CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == set_led_mode
  77   2              {
  78   3                  cur_discharge_rate = val;
  79   3              }
  80   2      
  81   2              cur_led_mode = set_led_mode;
  82   2              led_all_off();
  83   2              flag_led_setting_mode_exit_times_come = 0;
  84   2              led_setting_mode_exit_times_cnt = 0; // æ¸…ç©ºé€€å‡ºè®¾ç½®æ¨¡å¼çš„æ—¶é—´è®¡æ•°
  85   2      
  86   2              // led_status_clear();
  87   2      
  88   2              light_blink(val);
  89   2          }
  90   1      }
  91          
  92          //
  93          void led_handle(void)
  94          {
  95   1          // if (CUR_LED_MODE_OFF == cur_led_mode)
  96   1          // {
  97   1          //     // led_status_refresh();
  98   1          //     led_all_off();
  99   1      
 100   1          //     // last_led_mode = cur_led_mode;
 101   1          //     return;
 102   1          // }
 103   1      
 104   1          // å¦‚æœå½“å‰å¤„äºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 105   1          // è®¾å¤‡å¤„äºæ”¾ç”µæ—¶ï¼Œç”µé‡æŒ‡ç¤ºç¯åªæ˜¾ç¤ºç”µæ± ç”µé‡é™ä½çš„éƒ¨åˆ†
 106   1          if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode ||
 107   1              CUR_LED_MODE_BAT_INDICATIOR_IN_INSTRUCTION_MODE == cur_led_mode)
 108   1          {
 109   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæ”¾ç”µæ¨¡å¼ï¼ŒæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 110   2              LED_1_ON();
 111   2      
 112   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 113   2              {
 114   3                  cur_led_gear = 5; // äº®5æ ¼
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        08/08/2025 16:56:36 PAGE 3   

 115   3              }
 116   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
 117   2              {
 118   3                  cur_led_gear = 4; // äº®4æ ¼
 119   3              }
 120   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 121   2              {
 122   3                  cur_led_gear = 3; // äº®3æ ¼
 123   3              }
 124   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 125   2              {
 126   3                  cur_led_gear = 2; // äº®2æ ¼
 127   3              }
 128   2              else
 129   2              {
 130   3                  cur_led_gear = 1; // äº®1æ ¼
 131   3              }
 132   2      
 133   2              if (0 == last_led_gear)
 134   2              {
 135   3                  // å¦‚æœæœªåˆå§‹åŒ–
 136   3                  last_led_gear = cur_led_gear;
 137   3              }
 138   2              else
 139   2              {
 140   3                  // å¦‚æœ last_led_gear ä¸ä¸º0ï¼Œåˆ™è¯´æ˜å·²ç»åˆå§‹åŒ–è¿‡äº†
 141   3      
 142   3                  if (cur_led_gear > last_led_gear ||         //
 143   3                      (0 == flag_led_gear_update_times_come)) /* å¦‚æœæ›´æ–°æ—¶é—´è¿˜æœªåˆ°æ¥ */
 144   3                  {
 145   4                      // å¦‚æœå½“å‰è¦æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ å¤§äº ä¸Šæ¬¡æ˜¾ç¤ºçš„æŒ‡ç¤ºç¯ï¼ˆæ ·æœºåœ¨ç”µæ± ç”µå
             -‹ä¸Šå‡çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šæ›´æ–°æ˜¾ç¤ºï¼‰
 146   4                      cur_led_gear = last_led_gear;
 147   4                  }
 148   3      
 149   3                  if (flag_led_gear_update_times_come)
 150   3                  {
 151   4                      flag_led_gear_update_times_come = 0;
 152   4                  }
 153   3              }
 154   2      
 155   2              if (cur_led_gear >= 5)
 156   2              {
 157   3                  LED_5_ON();
 158   3              }
 159   2              else
 160   2              {
 161   3                  LED_5_OFF();
 162   3              }
 163   2      
 164   2              if (cur_led_gear >= 4)
 165   2              {
 166   3                  LED_4_ON();
 167   3              }
 168   2              else
 169   2              {
 170   3                  LED_4_OFF();
 171   3              }
 172   2      
 173   2              if (cur_led_gear >= 3)
 174   2              {
 175   3                  LED_3_ON();
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        08/08/2025 16:56:36 PAGE 4   

 176   3              }
 177   2              else
 178   2              {
 179   3                  LED_3_OFF();
 180   3              }
 181   2      
 182   2              if (cur_led_gear >= 2)
 183   2              {
 184   3                  LED_2_ON();
 185   3              }
 186   2              else
 187   2              {
 188   3                  LED_2_OFF();
 189   3              }
 190   2      
 191   2          } // if (CUR_LED_MODE_BAT_INDICATOR == cur_led_mode)
 192   1          else if (CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE == cur_led_mode ||
 193   1                   CUR_LED_MODE_DISCHARGE_RATE_IN_INSTRUCTION_MODE == cur_led_mode)
 194   1          {
 195   2              // æ”¾ç”µé€Ÿç‡æŒ‡ç¤ºæ¨¡å¼ï¼ŒM1ã€M2ã€M3ï¼Œéœ€è¦å¯¹åº”çš„æŒ‡ç¤ºç¯å¸¸äº®
 196   2              switch (cur_discharge_rate)
 197   2              {
 198   3              case 1:
 199   3                  LED_1_ON();
 200   3                  break;
 201   3              case 2:
 202   3                  LED_2_ON();
 203   3                  break;
 204   3              case 3:
 205   3                  LED_3_ON();
 206   3                  break;
 207   3              }
 208   2          }
 209   1          else if (CUR_LED_MODE_CHARGING == cur_led_mode) // å……ç”µæŒ‡ç¤ºæ¨¡å¼
 210   1          {
 211   2              // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 212   2              // TODOï¼šæ ·æœºæ˜¯åœ¨ç”µæ± ç”µå‹è¶…è¿‡3.55Vå¹¶ä¸”è¿›å…¥æ¶“æµå……ç”µï¼Œç»¿è‰²æŒ‡ç¤ºç¯æ‰ä¸€ç›´ç‚
             -¹äº®(ç¬¬5æ ¼æŒ‡ç¤ºç¯)
 213   2      
 214   2              /* ç‚¹äº®æŒ‡ç¤ºç¯1ï¼ˆæŒ‡ç¤ºç¯1å§‹ç»ˆç‚¹äº®ï¼‰ */
 215   2              LED_1_ON();
 216   2      
 217   2              // if (bat_adc_val > BAT_ADC_VAL_5) // ç”µæ± ç”µé‡å¤§äº5æ ¼
 218   2              // {
 219   2              //     cur_led_gear = 6; // äº®5æ ¼ï¼Œå¹¶ä¸”æ‰€æœ‰æŒ‡ç¤ºç¯å¸¸äº®
 220   2              // }
 221   2              // else if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 222   2              if (bat_adc_val > BAT_ADC_VAL_4) // ç”µæ± ç”µé‡å¤§äº4æ ¼
 223   2              {
 224   3                  cur_led_gear = 5; // äº®5æ ¼ï¼Œè®©ç¬¬5æ ¼é—ªçƒ
 225   3              }
 226   2              else if (bat_adc_val > BAT_ADC_VAL_3) // ç”µæ± ç”µé‡å¤§äº3æ ¼
 227   2              {
 228   3                  cur_led_gear = 4; // äº®4æ ¼ï¼Œè®©ç¬¬4æ ¼é—ªçƒ
 229   3              }
 230   2              else if (bat_adc_val > BAT_ADC_VAL_2) // ç”µæ± ç”µé‡å¤§äº2æ ¼
 231   2              {
 232   3                  cur_led_gear = 3; // äº®3æ ¼ï¼Œè®©ç¬¬3æ ¼é—ªçƒ
 233   3              }
 234   2              else if (bat_adc_val > BAT_ADC_VAL_1) // ç”µæ± ç”µé‡å¤§äº1æ ¼
 235   2              {
 236   3                  cur_led_gear = 2; // äº®2æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        08/08/2025 16:56:36 PAGE 5   

 237   3              }
 238   2              else
 239   2              {
 240   3                  cur_led_gear = 1; // äº®1æ ¼ï¼Œè®©ç¬¬2æ ¼é—ªçƒ
 241   3              }
 242   2      
 243   2              if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase || /* å¿«æ»¡ç”µ
             -ï¼Œæ¶“æµå……ç”µ */
 244   2                  CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)                                /* å·²ç»å……
             -æ»¡ç”µ */
 245   2              {
 246   3                  // æ ·æœºæ˜¯è¿›å…¥æ¶“æµå……ç”µæ‰æŠŠæ‰€æœ‰æŒ‡ç¤ºç¯å˜ä¸ºå¸¸äº®
 247   3                  cur_led_gear = 6;
 248   3              }
 249   2      
 250   2              if (0 == last_led_gear)
 251   2              {
 252   3                  last_led_gear = cur_led_gear;
 253   3              }
 254   2              else
 255   2              {
 256   3                  if (cur_led_gear < last_led_gear ||         /* å¦‚æœç”µæ± ç”µé‡æ¯”åŸæ¥çš„è¿˜è¦ä½ */
 257   3                      (0 == flag_led_gear_update_times_come)) /* å¦‚æœæ›´æ–°æ—¶é—´è¿˜æœªåˆ°æ¥ */
 258   3                  {
 259   4                      // åœ¨å……ç”µæŒ‡ç¤ºæ¨¡å¼ä¸­ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¸æ›´æ–°æ˜¾ç¤º
 260   4                      cur_led_gear = last_led_gear;
 261   4                  }
 262   3      
 263   3                  if (flag_led_gear_update_times_come)
 264   3                  {
 265   4                      flag_led_gear_update_times_come = 0;
 266   4                  }
 267   3              }
 268   2      
 269   2              cur_led_gear_in_charging = cur_led_gear; // æ›´æ–°æ•°å€¼ï¼Œç»™å®šæ—¶å™¨ä¸­æ–­ä½¿ç”¨
 270   2              delay_ms(1);
 271   2      
 272   2              if (cur_led_gear >= 3)
 273   2              {
 274   3                  LED_2_ON();
 275   3              }
 276   2      
 277   2              if (cur_led_gear >= 4)
 278   2              {
 279   3                  LED_3_ON();
 280   3              }
 281   2      
 282   2              if (cur_led_gear >= 5)
 283   2              {
 284   3                  LED_4_ON();
 285   3              }
 286   2      
 287   2              if (cur_led_gear >= 6)
 288   2              {
 289   3                  LED_5_ON();
 290   3              }
 291   2          }
 292   1      
 293   1          // ledè®¾ç½®æ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 294   1          if (flag_led_setting_mode_exit_times_come)
 295   1          {
 296   2              flag_led_setting_mode_exit_times_come = 0;
C51 COMPILER V9.60.7.0   LED_HANDLE                                                        08/08/2025 16:56:36 PAGE 6   

 297   2      
 298   2              flag_is_in_setting_mode = 0; // é€€å‡ºè®¾ç½®æ¨¡å¼
 299   2              flag_allow_light_in_setting_mode = 0;
 300   2      
 301   2              // å¦‚æœè¦å›åˆ° led_off
 302   2              if (flag_is_led_off_enable)
 303   2              {
 304   3                  flag_is_led_off_enable = 0;
 305   3                  cur_led_mode = CUR_LED_MODE_OFF;
 306   3              }
 307   2              else
 308   2              {
 309   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR; // æ¢å¤åˆ°ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 310   3              }
 311   2          }
 312   1      
 313   1          // ledæŒ‡ç¤ºç¯é€€å‡ºæŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´åˆ°æ¥
 314   1          if (flag_led_struction_mode_exit_times_come)
 315   1          {
 316   2              flag_led_struction_mode_exit_times_come = 0;
 317   2      
 318   2              flag_is_in_struction_mode = 0;
 319   2      
 320   2              // å¦‚æœè¦å›åˆ° led_off
 321   2              if (flag_is_led_off_enable)
 322   2              {
 323   3                  flag_is_led_off_enable = 0;
 324   3                  cur_led_mode = CUR_LED_MODE_OFF;
 325   3              }
 326   2              else
 327   2              {
 328   3                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR;
 329   3              }
 330   2          }
 331   1      
 332   1          if (CUR_LED_MODE_OFF == cur_led_mode)
 333   1          {
 334   2              led_all_off();
 335   2          }
 336   1      
 337   1          // last_led_mode = cur_led_mode;
 338   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    697    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
