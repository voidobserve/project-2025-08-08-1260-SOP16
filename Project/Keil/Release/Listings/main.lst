C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C) INCDI
                    -R(..\..\Libraries\Include;..\..\User;..\..\HardWare) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\main.lst) O
                    -BJECT(.\Release\Objects\main.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    main.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    01-05-2021
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           *
  11           * <h2><center>&copy; COPYRIGHT 2021 HUGE-IC</center></h2>
  12           *
  13           * ç‰ˆæƒè¯´æ˜åç»­è¡¥ä¸Š
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          /* Includes ------------------------------------------------------------------*/
  19          #include "include.h"
  20          #include "user_config.h"
  21          #include <stdio.h>
  22          
  23          volatile bit flag_is_led_1_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  24          volatile bit flag_is_led_2_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  25          volatile bit flag_is_led_3_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  26          volatile bit flag_is_led_4_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  27          volatile bit flag_is_led_5_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  28          
  29          // =================================================================
  30          // çº¢å¤–æ¥æ”¶ç›¸å…³å˜é‡                                                //
  31          // =================================================================
  32          volatile u8 ir_data = 0;
  33          volatile bit flag_is_recv_ir_repeat_code = 0;
  34          volatile bit flag_is_recved_data = 0;
  35          
  36          // =================================================================
  37          // å……ç”µæ§åˆ¶ç›¸å…³å˜é‡                                                 //
  38          // =================================================================
  39          volatile u16 bat_adc_val;                                           // ç”µæ± ç”µå‹æ£€æµ‹è„šé‡‡é›†åˆ°çš„ad
             -å€¼
  40          volatile u16 charging_adc_val;                                      // å……ç”µç”µå‹æ£€æµ‹è„šé‡‡é›†çš„adå€¼
  41          volatile u16 current_adc_val;                                       // å……ç”µç”µæµæ£€æµ‹è„šé‡‡é›†çš„adå€¼
  42          volatile u8 flag_is_charging_adjust_time_come = 0;                  // è°ƒèŠ‚å……ç”µçš„æ—¶é—´åˆ°æ¥
  43          volatile u8 cur_charging_pwm_status = CUR_CHARGING_PWM_STATUS_NONE; // æ§åˆ¶å……ç”µçš„PWMçŠ¶æ€
  44          volatile u8 cur_charge_phase = CUR_CHARGE_PHASE_NONE;               // è®°å½•å½“å‰å……ç”µé˜¶æ®µ
  45          
  46          // =================================================================
  47          // æŒ‡ç¤ºç¯æ§åˆ¶ç›¸å…³å˜é‡                                               //
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 2   

  48          // =================================================================
  49          volatile u8 cur_initial_discharge_gear; // åˆå§‹æ”¾ç”µæŒ¡ä½ï¼ˆéœ€è¦è®°å¿†ï¼‰
  50          volatile u8 cur_discharge_rate;         // åˆå§‹æ”¾ç”µé€Ÿç‡ï¼ˆéœ€è¦è®°å¿†ï¼‰
  51          volatile u8 cur_led_mode;               // å½“å‰çš„LEDæ¨¡å¼
  52          // volatile u8 last_led_mode; // ä¸Šæ¬¡çš„ledæ¨¡å¼
  53          volatile u8 cur_led_gear;             // å½“å‰ledæŒ¡ä½
  54          volatile u8 last_led_gear;            // ä¸Šæ¬¡ledæŒ¡ä½ï¼ˆåªèƒ½åœ¨åˆšä¸Šç”µæ—¶æ¸…é›¶èµ‹åˆå§‹å€¼ï¼‰
  55          volatile u8 cur_led_gear_in_charging; // å……ç”µæŒ‡ç¤ºï¼Œå¯¹åº”çš„æŒ¡ä½
  56          
  57          volatile bit flag_is_in_setting_mode = 0;              // æ˜¯å¦å¤„äºè®¾ç½®æ¨¡å¼
  58          volatile u8 flag_led_setting_mode_exit_times_come = 0; // æ ‡å¿—ä½ï¼Œledé€€å‡ºè®¾ç½®æ¨¡å¼çš„æ—¶é—´åˆ°æ¥
  59          volatile u16 led_setting_mode_exit_times_cnt = 0;      // ç‰¹æ®Šçš„LEDæ¨¡å¼ï¼Œé€€å‡ºæ—¶é—´è®¡æ•°
  60          
  61          volatile bit flag_is_in_struction_mode = 0;               // æ˜¯å¦å¤„äºæŒ‡ç¤ºæ¨¡å¼
  62          volatile bit flag_led_struction_mode_exit_times_come = 0; // é€€å‡ºæŒ‡ç¤ºç¯æŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´åˆ°æ¥
  63          volatile u16 led_struction_mode_exit_times_cnt = 0;       // é€€å‡ºæŒ‡ç¤ºç¯æŒ‡ç¤ºæ¨¡å¼æ—¶é—´è®¡æ•°
  64          
  65          volatile bit flag_led_gear_update_times_come = 0; // æŒ‡ç¤ºç¯çŠ¶æ€æ›´æ–°çš„æ—¶é—´åˆ°æ¥
  66          // volatile u16 led_gear_update_times_cnt = 0; // æŒ‡ç¤ºç¯çŠ¶æ€æ›´æ–°çš„æ—¶é—´è®¡æ•°
  67          
  68          // æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦å›åˆ° led_off æ¨¡å¼
  69          volatile bit flag_is_led_off_enable = 0;
  70          
  71          // =================================================================
  72          // ä¸»ç¯å…‰æ§åˆ¶ç›¸å…³å˜é‡                                               //
  73          // =================================================================
  74          volatile u32 light_adjust_time_cnt = 0;    // è°ƒèŠ‚ç¯å…‰çš„æ—¶é—´è®¡æ•°ï¼Œæš‚å®šä¸ºæ¯1såŠ ä¸€
  75          volatile u8 light_ctl_phase_in_rate_1 = 1; // åœ¨æ”¾ç”µé€Ÿç‡M1æ—¶ï¼Œä½¿ç”¨åˆ°çš„å˜é‡ï¼Œåœ¨è®¡ç®—å…¬å¼é
             -‡Œé¢ç”¨ä½œç³»æ•°ï¼Œæ¯æ¬¡å”¤é†’æ—¶éœ€è¦åˆå§‹åŒ–ä¸º1
  76          
  77          // TODOï¼š3260ä½¿ç”¨16ä½å¯„å­˜å™¨ï¼Œ7361ä½¿ç”¨8ä½å¯„å­˜å™¨ï¼Œè¦è¿›è¡Œé€‚é…ä¿®æ”¹
  78          volatile u16 cur_light_pwm_duty_val = 0; // å½“å‰ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  79          // volatile u16 expect_light_pwm_duty_val = 0;                  // æœŸæœ›è°ƒèŠ‚åˆ°çš„ã€ç¯å…‰å¯¹åº”çš„å 
             -ç©ºæ¯”å€¼
  80          volatile u8 flag_is_light_adjust_time_come = 0;              // è°ƒèŠ‚ç¯å…‰çš„æ—¶é—´åˆ°æ¥ï¼Œç›®å‰ä¸º1s
  81          volatile u8 flag_is_light_pwm_duty_val_adjust_time_come = 0; // ç¯å…‰å ç©ºæ¯”å€¼è°ƒèŠ‚æ—¶é—´åˆ°æ¥
  82          
  83          volatile u8 flag_is_ctl_light_blink = 0; // æ˜¯å¦æ§åˆ¶ä¸»ç¯å…‰é—ªçƒ
  84          volatile u8 light_ctl_blink_times = 0;   // è¦æ§åˆ¶ä¸»ç¯å…‰é—ªçƒçš„æ¬¡æ•°
  85          /*
  86              æ˜¯å¦è¦åœ¨è®¾ç½®æ¨¡å¼æœŸé—´å…³é—­ä¸»ç¯å…‰
  87          
  88              å¦‚æœå·²ç»å…³ç¯ï¼Œåœ¨è®¾ç½®æ¨¡å¼æœŸé—´ï¼Œä¸»ç¯é—ªçƒå®Œæˆåï¼Œç›´æ¥å…³ç¯
  89          */
  90          volatile bit flag_allow_light_in_setting_mode = 0;
  91          
  92          // æ˜¯å¦è¦ç¼“æ…¢è°ƒèŠ‚ä¸»ç¯å…‰çš„å ç©ºæ¯”
  93          volatile bit flag_is_adjust_light_slowly = 0;
  94          volatile u16 expect_light_pwm_duty_val = 0; // æœŸæœ›ç¼“æ…¢è°ƒèŠ‚åˆ°çš„ã€ä¸»ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  95          
  96          // æ˜¯å¦å¼€å¯äº†å®šæ—¶å…³æœºåŠŸèƒ½ï¼š
  97          volatile bit flag_is_auto_shutdown_enable = 0;
  98          volatile u32 light_auto_shutdown_time_cnt = 0;     // å®šæ—¶å…³æœºåŠŸèƒ½çš„å®šæ—¶å™¨è®¡æ•°ï¼Œå•ä½ï¼šms
  99          volatile bit flag_is_auto_shutdown_times_come = 0; // æ ‡å¿—ä½ï¼Œå®šæ—¶å…³æœºçš„æ—¶é—´æ˜¯å¦åˆ°æ¥ï¼Œ0--å
             -®šæ—¶å…³æœºçš„æ—¶é—´æœªåˆ°æ¥ï¼Œ1--å®šæ—¶å…³æœºçš„æ—¶é—´å·²ç»åˆ°æ¥
 100          
 101          // çŸ­æŒ‰å‡å°ç¯å…‰äº®åº¦ï¼Œå¯¹åº”å„ä¸ªæŒ¡ä½äº®åº¦çš„å ç©ºæ¯”å€¼
 102          const u16 light_pwm_sub_table[9] = {
 103              (u16)((u32)TIMER2_FEQ * 8367 / 10000), // 83.67 %
 104              (u16)((u32)TIMER2_FEQ * 7371 / 10000), // 73.71 %
 105              (u16)((u32)TIMER2_FEQ * 6375 / 10000), // 63.75 %
 106              (u16)((u32)TIMER2_FEQ * 5379 / 10000), // 53.79 %
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 3   

 107              (u16)((u32)TIMER2_FEQ * 4383 / 10000), // 43.83 %
 108              (u16)((u32)TIMER2_FEQ * 3387 / 10000), // 33.87 %
 109              (u16)((u32)TIMER2_FEQ * 2391 / 10000), // 23.91 %
 110              (u16)((u32)TIMER2_FEQ * 1395 / 10000), // 13.95 %
 111              (u16)((u32)TIMER2_FEQ * 478 / 10000),  // 4.78 %
 112          };
 113          
 114          // çŸ­æŒ‰å¢åŠ ç¯å…‰äº®åº¦ï¼Œå¯¹åº”å„ä¸ªæŒ¡ä½äº®åº¦çš„å ç©ºæ¯”å€¼
 115          const u16 light_pwm_add_table[9] = {
 116              (u16)((u32)TIMER2_FEQ * 478 / 10000),  // 4.78 %
 117              (u16)((u32)TIMER2_FEQ * 1474 / 10000), // 14.74 %
 118              (u16)((u32)TIMER2_FEQ * 2470 / 10000), // 24.70 %
 119              (u16)((u32)TIMER2_FEQ * 3466 / 10000), // 34.66 %
 120              (u16)((u32)TIMER2_FEQ * 4462 / 10000), // 44.62 %
 121              (u16)((u32)TIMER2_FEQ * 5458 / 10000), // 54.58 %
 122              (u16)((u32)TIMER2_FEQ * 6554 / 10000), // 65.54 %
 123              (u16)((u32)TIMER2_FEQ * 7450 / 10000), // 74.50 %
 124              (u16)((u32)TIMER2_FEQ * 8367 / 10000), // 83.67 %
 125          };
 126          
 127          const u16 light_pwm_duty_init_val_table[5] = {
 128              (u16)((u32)TIMER2_FEQ * 8367 / 10000), // 83.67 %
 129              (u16)((u32)TIMER2_FEQ * 7411 / 10000), // 74.11 %
 130              (u16)((u32)TIMER2_FEQ * 6455 / 10000), // 64.55 %
 131              (u16)((u32)TIMER2_FEQ * 5698 / 10000), // 56.98 %
 132              (u16)((u32)TIMER2_FEQ * 4980 / 10000), // 49.80 %
 133          };
 134          
 135          void led_pin_config(void)
 136          {
 137   1          P0_MD0 &= ~GPIO_P00_MODE_SEL(0x03);
 138   1          P0_MD0 |= GPIO_P00_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 139   1          FOUT_S00 = GPIO_FOUT_AF_FUNC;      // é€‰æ‹©AFåŠŸèƒ½è¾“å‡º
 140   1          P00 = 0;                           // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 141   1      
 142   1          P0_MD1 &= ~GPIO_P05_MODE_SEL(0x03);
 143   1          P0_MD1 |= GPIO_P05_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 144   1          FOUT_S05 = GPIO_FOUT_AF_FUNC;
 145   1          P05 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 146   1      
 147   1          P0_MD1 &= ~GPIO_P06_MODE_SEL(0x03);
 148   1          P0_MD1 |= GPIO_P06_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 149   1          FOUT_S06 = GPIO_FOUT_AF_FUNC;
 150   1          P06 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 151   1      
 152   1          P1_MD0 &= ~GPIO_P13_MODE_SEL(0x03);
 153   1          P1_MD0 |= GPIO_P13_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 154   1          FOUT_S13 = GPIO_FOUT_AF_FUNC;
 155   1          P13 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 156   1      
 157   1          P1_MD1 &= ~GPIO_P14_MODE_SEL(0x03);
 158   1          P1_MD1 |= GPIO_P14_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 159   1          FOUT_S14 = GPIO_FOUT_AF_FUNC;
 160   1          P14 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 161   1      }
 162          
 163          /*
 164              å˜é‡ã€å‚æ•°ï¼Œåˆå§‹åŒ–
 165          
 166              å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¸Šç”µï¼Œéœ€è¦è¯»å‡ºå­˜æ”¾çš„æ•°æ®
 167          */
 168          void param_init(void)
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 4   

 169          {
 170   1          light_ctl_phase_in_rate_1 = 1;
 171   1      
 172   1          cur_initial_discharge_gear = 5; // åˆå§‹æ”¾ç”µæŒ¡ä½ï¼ˆéœ€è¦è®°å¿†ï¼‰
 173   1          cur_discharge_rate = 2;         // åˆå§‹æ”¾ç”µé€Ÿç‡ï¼ˆéœ€è¦è®°å¿†ï¼‰
 174   1      }
 175          
 176          // å…³æœºï¼Œæœ€åè®©æŒ‡ç¤ºç¯ç†„ç­ï¼Œä¸»ç¯å…‰ç†„ç­ï¼Œå‡†å¤‡è¿›å…¥ä½åŠŸè€—
 177          void power_off(void)
 178          {
 179   1          flag_is_adjust_light_slowly = 0;      // å…³é—­ç¼“æ…¢è°ƒèŠ‚ä¸»ç¯å…‰çš„æ“ä½œ
 180   1          flag_is_auto_shutdown_enable = 0;     // ä¸ä½¿èƒ½è‡ªåŠ¨å…³æœº
 181   1          flag_is_auto_shutdown_times_come = 0; // æ¸…é™¤å®šæ—¶å…³æœºæ ‡å¿—
 182   1          led_status_clear();
 183   1          cur_led_mode = CUR_LED_MODE_OFF;
 184   1          cur_light_pwm_duty_val = 0;
 185   1          LIGHT_OFF();
 186   1      }
 187          
 188          void user_init(void)
 189          {
 190   1          uart0_config();
 191   1      
 192   1          timer0_config();
 193   1          timer1_pwm_config(); // æ§åˆ¶å……ç”µçš„PWM
 194   1          timer1_pwm_disable();
 195   1          timer2_pwm_config(); // æ§åˆ¶ç¯å…‰çš„pwm
 196   1          timer2_pwm_disable();
 197   1      
 198   1          led_pin_config(); // ledæŒ‡ç¤ºç¯
 199   1      
 200   1          // çº¢å¤–æ¥æ”¶å¼•è„šï¼š
 201   1          // P2_MD0 &= ~(GPIO_P23_MODE_SEL(0x03)); // è¾“å…¥æ¨¡å¼
 202   1          // P2_PU |= GPIO_P23_PULL_UP(0x01);      // ä¸Šæ‹‰
 203   1      
 204   1          P0_PU |= GPIO_P02_PULL_UP(0x01);    // ä¸Šæ‹‰
 205   1          P0_MD0 &= ~GPIO_P02_MODE_SEL(0x03); // è¾“å…¥æ¨¡å¼
 206   1      
 207   1          adc_config();
 208   1          pga_config();
*** WARNING C206 IN LINE 208 OF ..\..\User\main.c: 'pga_config': missing function-prototype
 209   1      
 210   1          // ä¸Šç”µåï¼Œéœ€è¦å…ˆç‚¹äº®çº¢è‰²æŒ‡ç¤ºç¯ï¼Œå†å˜ä¸ºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 211   1          LED_1_ON();
 212   1          delay_ms(1000);
 213   1      
 214   1          param_init();
 215   1      
 216   1          light_init();
 217   1          led_init();
 218   1          led_mode_alter(CUR_LED_MODE_BAT_INDICATOR); // ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 219   1      
 220   1          delay_ms(1); // ç­‰å¾…ç³»ç»Ÿç¨³å®š
 221   1      }
 222          
 223          /**
 224           * @brief  Main program.
 225           * @param  None
 226           * @retval None
 227           */
 228          void main(void)
 229          {
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 5   

 230   1          // çœ‹é—¨ç‹—é»˜è®¤æ‰“å¼€, å¤ä½æ—¶é—´2s
 231   1          WDT_KEY = WDT_KEY_VAL(0xDD); //  å…³é—­çœ‹é—¨ç‹— (å¦‚éœ€é…ç½®çœ‹é—¨ç‹—è¯·æŸ¥çœ‹â€œWDT\WDT_Resetâ€ç¤º
             -ä¾‹)
 232   1      
 233   1          system_init();
 234   1      
 235   1          // å…³é—­HCKå’ŒHDAçš„è°ƒè¯•åŠŸèƒ½
 236   1          WDT_KEY = 0x55;  // è§£é™¤å†™ä¿æŠ¤
 237   1          IO_MAP &= ~0x01; // æ¸…é™¤è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå®ç°å…³é—­HCKå’ŒHDAå¼•è„šçš„è°ƒè¯•åŠŸèƒ½ï¼ˆè§£é™¤æ
             -˜ å°„ï¼‰
 238   1          WDT_KEY = 0xBB;  // å†™ä¸€ä¸ªæ— æ•ˆçš„æ•°æ®ï¼Œè§¦å‘å†™ä¿æŠ¤
 239   1      
 240   1          user_init();
 241   1      
 242   1          // printf("sys reset\n");
 243   1      
 244   1          while (1)
 245   1          {
 246   2              // low_energy();
 247   2      
 248   2      #if 1
 249   2      
 250   2              /* åœ¨æ”¾ç”µæ—¶ï¼Œæ£€æµ‹ç”µæ± ç”µå‹ï¼Œä¸€æ—¦ä½äº2.5Vï¼Œç›´æ¥å…³æœº */
 251   2              if (cur_charge_phase == CUR_CHARGE_PHASE_NONE || /* å¦‚æœä¸åœ¨å……ç”µ */
 252   2                  cur_led_mode != CUR_LED_MODE_OFF)            /* å¦‚æœledæŒ‡ç¤ºç¯è¿˜æœªå…³é—­ */
 253   2              {
 254   3                  /*
 255   3                      å¦‚æœè¿›å…¥è¯¥æ¡ä»¶ï¼Œå¯èƒ½æ­£åœ¨æ”¾ç”µï¼Œæ£€æµ‹ç”µæ± ç”µå‹ï¼Œä¸€æ—¦ä½äº2.5Vï¼Œç›´æ
             -¥å…³æœº
 256   3                  */
 257   3                  adc_update_bat_adc_val();
 258   3                  // ç”µæ± ç”µå‹æ£€æµ‹è„šæ£€æµ‹åˆ°çš„ç”µå‹ï¼Œæ˜¯ç”µæ± çš„1/2åˆ†å‹ï¼Œadcä½¿ç”¨2Vå‚è€ƒç”µå‹
 259   3                  if (bat_adc_val < (u16)((u32)2500 * 4096 / 2 / 2 / 1000))
 260   3                  {
 261   4                      power_off();
 262   4                  }
 263   3              }
 264   2      
 265   2              charge_handle();
 266   2              ir_handle(); // å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­æ˜¯å¦åœ¨å……ç”µï¼Œå¦‚æœåœ¨å……ç”µåˆ™é€€å‡º
 267   2      
 268   2              /*
 269   2                  ã€éå……ç”µæ¨¡å¼ã€‘ -> ã€å……ç”µæ¨¡å¼ã€‘
 270   2      
 271   2                  å¦‚æœå½“å‰æ­£åœ¨å……ç”µï¼Œä½†æ˜¯æŒ‡ç¤ºç¯æ²¡æœ‰åˆ‡æ¢åˆ°å……ç”µæŒ‡ç¤ºæ¨¡å¼ï¼Œåˆ™åˆ‡æ¢ï¼š
 272   2              */
 273   2              if (CUR_CHARGE_PHASE_NONE != cur_charge_phase)
 274   2              {
 275   3                  // if (cur_led_mode != CUR_LED_MODE_CHARGING && /* æŒ‡ç¤ºç¯ä¸å¤„äºå……ç”µæ¨¡å¼ */
 276   3                  //     cur_led_mode != CUR_LED_MODE_OFF)
 277   3                  if (cur_led_mode != CUR_LED_MODE_CHARGING) /* æŒ‡ç¤ºç¯ä¸å¤„äºå……ç”µæ¨¡å¼ */
 278   3                  {
 279   4                      // æ¸…ç©ºå®šæ—¶å…³æœºç›¸å…³çš„å˜é‡
 280   4                      flag_is_auto_shutdown_enable = 0;
 281   4                      led_status_clear();
 282   4                      led_mode_alter(CUR_LED_MODE_CHARGING);
 283   4                  }
 284   3      
 285   3                  // éœ€è¦å…³é—­ä¸»ç¯å…‰
 286   3                  LIGHT_OFF();
 287   3              } // if (CUR_CHARGE_PHASE_NONE != cur_charge_phase)
 288   2              else // CUR_CHARGE_PHASE_NONE == cur_charge_phase
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 6   

 289   2              {
 290   3                  /*
 291   3                      ã€å……ç”µæ¨¡å¼ã€‘ -> ã€æ”¾ç”µã€ç‚¹äº®ä¸»ç¯å…‰ã€æŒ‡ç¤ºç¯å¯¹åº”ç”µæ± ç”µé‡æŒ‡ç¤ºã€‘
 292   3                      å¦‚æœå½“å‰æ²¡æœ‰åœ¨å……ç”µï¼Œå¹¶ä¸”æŒ‡ç¤ºç¯å¤„äºå……ç”µæŒ‡ç¤ºæ¨¡å¼ï¼Œ
 293   3                      åˆ‡æ¢å›ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 294   3      
 295   3                      æµ‹è¯•æ—¶å‘ç°ä»å……ç”µåˆ°æ–­å¼€å……ç”µï¼ŒledæŒ‡ç¤ºç¯è¿˜åœ¨é—ªçƒï¼Œéœ€è¦åŠ ä¸Šè¿™è¡¥ä¸
 296   3                  */
 297   3                  if (cur_led_mode == CUR_LED_MODE_CHARGING)
 298   3                  {
 299   4                      led_status_clear();
 300   4                      led_mode_alter(CUR_LED_MODE_BAT_INDICATOR);
 301   4                      // éœ€è¦æ‰“å¼€ä¸»ç¯å…‰
 302   4      
 303   4                      // æŸ¥è¡¨ï¼Œè·å¾—æŒ¡ä½å¯¹åº”çš„å ç©ºæ¯”å€¼
 304   4                      cur_light_pwm_duty_val = light_pwm_duty_init_val_table[cur_initial_discharge_gear - 1];
 305   4      
 306   4                      LIGHT_SET_PWM_DUTY(cur_light_pwm_duty_val); // ç«‹åˆ»æ›´æ–°PWMå ç©ºæ¯”
 307   4                      LIGHT_ON();                                 // ä½¿èƒ½ PWM è¾“å‡º
 308   4                  }
 309   3              }
 310   2      
 311   2              // å¦‚æœå®šæ—¶å…³æœºçš„æ—¶é—´åˆ°æ¥
 312   2              if (flag_is_auto_shutdown_times_come)
 313   2              {
 314   3                  // flag_is_auto_shutdown_times_come = 0; // æ¸…ç©ºå®šæ—¶å…³æœºæ ‡å¿—
 315   3                  // flag_is_auto_shutdown_enable = 0;     // ä¸å…è®¸è‡ªåŠ¨å…³æœº
 316   3                  // led_status_clear();
 317   3                  // cur_led_mode = CUR_LED_MODE_OFF;
 318   3                  // cur_light_pwm_duty_val = 0;
 319   3                  // LIGHT_OFF();
 320   3                  power_off();
 321   3                  // printf("power off\n");
 322   3              }
 323   2      
 324   2              adc_update_bat_adc_val();
 325   2              led_handle();
 326   2              light_handle();
 327   2      
 328   2      #if 0  // æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯ï¼š
              
                      {
                          static u8 cnt = 0;
                          cnt++;
                          if (cnt >= 200)
                          {
                              cnt = 0;
                              // printf("bat_adc_val %u\n", bat_adc_val);
                              // printf("cur_light_pwm_duty_val %u\n", cur_light_pwm_duty_val);
                              // printf("cur light pwm percent %bu %%\n", (u8)((u32)cur_light_pwm_duty_val * 100 / TIMER
             -2_FEQ));
              
                              switch (cur_led_mode)
                              {
                              case CUR_LED_MODE_OFF:
                                  printf("led mode off\n");
                                  break;
              
                              case CUR_LED_MODE_BAT_INDICATOR:
                                  printf("led mode bat indicator\n");
                                  break;
              
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 7   

                              case CUR_LED_MODE_CHARGING:
                                  printf("led mode charging\n");
                                  break;
              
                              case CUR_LED_MODE_SETTING:
                                  printf("led mode setting\n");
                                  break;
              
                              case CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE:
                                  printf("led mode initial discharge gear in setting mode\n");
                                  break;
              
                              case CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE:
                                  printf("led mode discharge rate in setting mode\n");
                                  break;
              
                              case CUR_LED_MODE_BAT_INDICATIOR_IN_INSTRUCTION_MODE:
                                  printf("led mode bat indicator in instruction mode\n");
                                  break;
              
                              case CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_INSTRUCTION_MODE:
                                  printf("led mode initial discharge gear in instruction mode\n");
                                  break;
              
                              case CUR_LED_MODE_DISCHARGE_RATE_IN_INSTRUCTION_MODE:
                                  printf("led mode discharge rate in instruction mode\n");
                                  break;
              
                              default:
                                  break;
                              }
                          }
                      }
              #endif // æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯
 384   2      
 385   2      #if 0  // demoæ¿ä½¿ç”¨åˆ°çš„è°ƒè¯•æŒ‡ç¤ºç¯
                      if (CUR_CHARGE_PHASE_NONE == cur_charge_phase)
                      {
                          my_debug_led_2_off();
                          my_debug_led_3_off();
                          my_debug_led_4_off();
              
                          my_debug_led_1_on();
                      }
                      else if (CUR_CHARGE_PHASE_NORMAL_CHARGE == cur_charge_phase)
                      {
                          my_debug_led_1_off();
                          my_debug_led_3_off();
                          my_debug_led_4_off();
              
                          my_debug_led_2_on();
                      }
                      else if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase)
                      {
                          my_debug_led_1_off();
                          my_debug_led_2_off();
                          my_debug_led_4_off();
              
                          my_debug_led_3_on();
                      }
                      else if (CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)
                      {
C51 COMPILER V9.60.7.0   MAIN                                                              08/11/2025 14:33:36 PAGE 8   

                          my_debug_led_1_off();
                          my_debug_led_2_off();
                          my_debug_led_3_off();
              
                          my_debug_led_4_on();
                      }
              #endif // demoæ¿ä½¿ç”¨åˆ°çš„è°ƒè¯•æŒ‡ç¤ºç¯
 419   2      
 420   2      #endif
 421   2          }
 422   1      }
 423          
 424          /**
 425           * @}
 426           */
 427          
 428          /*************************** (C) COPYRIGHT 2021 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    347    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     84    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     16    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
