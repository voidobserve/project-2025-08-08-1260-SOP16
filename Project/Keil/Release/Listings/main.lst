C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C) INCDI
                    -R(..\..\Libraries\Include;..\..\User;..\..\HardWare) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\main.lst) O
                    -BJECT(.\Release\Objects\main.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    main.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    01-05-2021
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           *
  11           * <h2><center>&copy; COPYRIGHT 2021 HUGE-IC</center></h2>
  12           *
  13           * ç‰ˆæƒè¯´æ˜åç»­è¡¥ä¸Š
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          /* Includes ------------------------------------------------------------------*/
  19          #include "include.h"
  20          #include "user_config.h"
  21          #include <stdio.h>
  22          
  23          volatile bit flag_is_led_1_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  24          volatile bit flag_is_led_2_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  25          volatile bit flag_is_led_3_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  26          volatile bit flag_is_led_4_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  27          volatile bit flag_is_led_5_enable; // led  æ˜¯å¦ä½¿èƒ½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œled ç†„ç­ï¼Œ1--ä½¿èƒ½ï¼Œled ç‚¹ä
             -º®
  28          
  29          // =================================================================
  30          // çº¢å¤–æ¥æ”¶ç›¸å…³å˜é‡                                                //
  31          // =================================================================
  32          volatile u8 ir_data = 0;
  33          volatile bit flag_is_recv_ir_repeat_code = 0;
  34          volatile bit flag_is_recved_data = 0;
  35          
  36          // =================================================================
  37          // å……ç”µæ§åˆ¶ç›¸å…³å˜é‡                                                 //
  38          // =================================================================
  39          volatile u16 bat_adc_val;                                           // ç”µæ± ç”µå‹æ£€æµ‹è„šé‡‡é›†åˆ°çš„ad
             -å€¼
  40          volatile u16 charging_adc_val;                                      // å……ç”µç”µå‹æ£€æµ‹è„šé‡‡é›†çš„adå€¼
  41          volatile u16 current_adc_val;                                       // å……ç”µç”µæµæ£€æµ‹è„šé‡‡é›†çš„adå€¼
  42          volatile u8 flag_is_charging_adjust_time_come = 0;                  // è°ƒèŠ‚å……ç”µçš„æ—¶é—´åˆ°æ¥
  43          volatile u8 cur_charging_pwm_status = CUR_CHARGING_PWM_STATUS_NONE; // æ§åˆ¶å……ç”µçš„PWMçŠ¶æ€
  44          volatile u8 cur_charge_phase = CUR_CHARGE_PHASE_NONE;               // è®°å½•å½“å‰å……ç”µé˜¶æ®µ
  45          
  46          // =================================================================
  47          // æŒ‡ç¤ºç¯æ§åˆ¶ç›¸å…³å˜é‡                                               //
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 2   

  48          // =================================================================
  49          volatile u8 cur_initial_discharge_gear; // åˆå§‹æ”¾ç”µæŒ¡ä½ï¼ˆéœ€è¦è®°å¿†ï¼‰
  50          volatile u8 cur_discharge_rate;         // åˆå§‹æ”¾ç”µé€Ÿç‡ï¼ˆéœ€è¦è®°å¿†ï¼‰
  51          volatile u8 cur_led_mode;               // å½“å‰çš„LEDæ¨¡å¼
  52          // volatile u8 last_led_mode; // ä¸Šæ¬¡çš„ledæ¨¡å¼
  53          volatile u8 cur_led_gear;             // å½“å‰ledæŒ¡ä½
  54          volatile u8 last_led_gear;            // ä¸Šæ¬¡ledæŒ¡ä½ï¼ˆåªèƒ½åœ¨åˆšä¸Šç”µæ—¶æ¸…é›¶èµ‹åˆå§‹å€¼ï¼‰
  55          volatile u8 cur_led_gear_in_charging; // å……ç”µæŒ‡ç¤ºï¼Œå¯¹åº”çš„æŒ¡ä½
  56          
  57          volatile bit flag_is_in_setting_mode = 0;              // æ˜¯å¦å¤„äºè®¾ç½®æ¨¡å¼
  58          volatile u8 flag_led_setting_mode_exit_times_come = 0; // æ ‡å¿—ä½ï¼Œledé€€å‡ºè®¾ç½®æ¨¡å¼çš„æ—¶é—´åˆ°æ¥
  59          volatile u16 led_setting_mode_exit_times_cnt = 0;      // ç‰¹æ®Šçš„LEDæ¨¡å¼ï¼Œé€€å‡ºæ—¶é—´è®¡æ•°
  60          
  61          volatile bit flag_is_in_struction_mode = 0;               // æ˜¯å¦å¤„äºæŒ‡ç¤ºæ¨¡å¼
  62          volatile bit flag_led_struction_mode_exit_times_come = 0; // é€€å‡ºæŒ‡ç¤ºç¯æŒ‡ç¤ºæ¨¡å¼çš„æ—¶é—´åˆ°æ¥
  63          volatile u16 led_struction_mode_exit_times_cnt = 0;       // é€€å‡ºæŒ‡ç¤ºç¯æŒ‡ç¤ºæ¨¡å¼æ—¶é—´è®¡æ•°
  64          
  65          volatile bit flag_led_gear_update_times_come = 0; // æŒ‡ç¤ºç¯çŠ¶æ€æ›´æ–°çš„æ—¶é—´åˆ°æ¥
  66          // volatile u16 led_gear_update_times_cnt = 0; // æŒ‡ç¤ºç¯çŠ¶æ€æ›´æ–°çš„æ—¶é—´è®¡æ•°
  67          
  68          // æ ‡å¿—ä½ï¼Œæ˜¯å¦è¦å›åˆ° led_off æ¨¡å¼
  69          volatile bit flag_is_led_off_enable = 0;
  70          
  71          // =================================================================
  72          // ä¸»ç¯å…‰æ§åˆ¶ç›¸å…³å˜é‡                                               //
  73          // =================================================================
  74          volatile u32 light_adjust_time_cnt = 0;    // è°ƒèŠ‚ç¯å…‰çš„æ—¶é—´è®¡æ•°ï¼Œæš‚å®šä¸ºæ¯1såŠ ä¸€
  75          volatile u8 light_ctl_phase_in_rate_1 = 1; // åœ¨æ”¾ç”µé€Ÿç‡M1æ—¶ï¼Œä½¿ç”¨åˆ°çš„å˜é‡ï¼Œåœ¨è®¡ç®—å…¬å¼é
             -‡Œé¢ç”¨ä½œç³»æ•°ï¼Œæ¯æ¬¡å”¤é†’æ—¶éœ€è¦åˆå§‹åŒ–ä¸º1
  76          
  77          // TODOï¼š3260ä½¿ç”¨16ä½å¯„å­˜å™¨ï¼Œ7361ä½¿ç”¨8ä½å¯„å­˜å™¨ï¼Œè¦è¿›è¡Œé€‚é…ä¿®æ”¹
  78          volatile u16 cur_light_pwm_duty_val = 0; // å½“å‰ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  79          // volatile u16 expect_light_pwm_duty_val = 0;                  // æœŸæœ›è°ƒèŠ‚åˆ°çš„ã€ç¯å…‰å¯¹åº”çš„å 
             -ç©ºæ¯”å€¼
  80          volatile u8 flag_is_light_adjust_time_come = 0;              // è°ƒèŠ‚ç¯å…‰çš„æ—¶é—´åˆ°æ¥ï¼Œç›®å‰ä¸º1s
  81          volatile u8 flag_is_light_pwm_duty_val_adjust_time_come = 0; // ç¯å…‰å ç©ºæ¯”å€¼è°ƒèŠ‚æ—¶é—´åˆ°æ¥
  82          
  83          volatile u8 flag_is_ctl_light_blink = 0; // æ˜¯å¦æ§åˆ¶ä¸»ç¯å…‰é—ªçƒ
  84          volatile u8 light_ctl_blink_times = 0;   // è¦æ§åˆ¶ä¸»ç¯å…‰é—ªçƒçš„æ¬¡æ•°
  85          /*
  86              æ˜¯å¦è¦åœ¨è®¾ç½®æ¨¡å¼æœŸé—´å…³é—­ä¸»ç¯å…‰
  87          
  88              å¦‚æœå·²ç»å…³ç¯ï¼Œåœ¨è®¾ç½®æ¨¡å¼æœŸé—´ï¼Œä¸»ç¯é—ªçƒå®Œæˆåï¼Œç›´æ¥å…³ç¯
  89          */
  90          volatile bit flag_allow_light_in_setting_mode = 0;
  91          
  92          // æ˜¯å¦è¦ç¼“æ…¢è°ƒèŠ‚ä¸»ç¯å…‰çš„å ç©ºæ¯”
  93          volatile bit flag_is_adjust_light_slowly = 0;
  94          volatile u16 expect_light_pwm_duty_val = 0; // æœŸæœ›ç¼“æ…¢è°ƒèŠ‚åˆ°çš„ã€ä¸»ç¯å…‰å¯¹åº”çš„å ç©ºæ¯”å€¼
  95          
  96          // æ˜¯å¦å¼€å¯äº†å®šæ—¶å…³æœºåŠŸèƒ½ï¼š
  97          volatile bit flag_is_auto_shutdown_enable = 0;
  98          volatile u32 light_auto_shutdown_time_cnt = 0;     // å®šæ—¶å…³æœºåŠŸèƒ½çš„å®šæ—¶å™¨è®¡æ•°ï¼Œå•ä½ï¼šms
  99          volatile bit flag_is_auto_shutdown_times_come = 0; // æ ‡å¿—ä½ï¼Œå®šæ—¶å…³æœºçš„æ—¶é—´æ˜¯å¦åˆ°æ¥ï¼Œ0--å
             -®šæ—¶å…³æœºçš„æ—¶é—´æœªåˆ°æ¥ï¼Œ1--å®šæ—¶å…³æœºçš„æ—¶é—´å·²ç»åˆ°æ¥
 100          
 101          // çŸ­æŒ‰å‡å°ç¯å…‰äº®åº¦ï¼Œå¯¹åº”å„ä¸ªæŒ¡ä½äº®åº¦çš„å ç©ºæ¯”å€¼
 102          const u16 light_pwm_sub_table[9] = {
 103              (u16)((u32)TIMER2_FEQ * 8367 / 10000), // 83.67 %
 104              (u16)((u32)TIMER2_FEQ * 7371 / 10000), // 73.71 %
 105              (u16)((u32)TIMER2_FEQ * 6375 / 10000), // 63.75 %
 106              (u16)((u32)TIMER2_FEQ * 5379 / 10000), // 53.79 %
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 3   

 107              (u16)((u32)TIMER2_FEQ * 4383 / 10000), // 43.83 %
 108              (u16)((u32)TIMER2_FEQ * 3387 / 10000), // 33.87 %
 109              (u16)((u32)TIMER2_FEQ * 2391 / 10000), // 23.91 %
 110              (u16)((u32)TIMER2_FEQ * 1395 / 10000), // 13.95 %
 111              (u16)((u32)TIMER2_FEQ * 478 / 10000),  // 4.78 %
 112          };
 113          
 114          // çŸ­æŒ‰å¢åŠ ç¯å…‰äº®åº¦ï¼Œå¯¹åº”å„ä¸ªæŒ¡ä½äº®åº¦çš„å ç©ºæ¯”å€¼
 115          const u16 light_pwm_add_table[9] = {
 116              (u16)((u32)TIMER2_FEQ * 478 / 10000),  // 4.78 %
 117              (u16)((u32)TIMER2_FEQ * 1474 / 10000), // 14.74 %
 118              (u16)((u32)TIMER2_FEQ * 2470 / 10000), // 24.70 %
 119              (u16)((u32)TIMER2_FEQ * 3466 / 10000), // 34.66 %
 120              (u16)((u32)TIMER2_FEQ * 4462 / 10000), // 44.62 %
 121              (u16)((u32)TIMER2_FEQ * 5458 / 10000), // 54.58 %
 122              (u16)((u32)TIMER2_FEQ * 6554 / 10000), // 65.54 %
 123              (u16)((u32)TIMER2_FEQ * 7450 / 10000), // 74.50 %
 124              (u16)((u32)TIMER2_FEQ * 8367 / 10000), // 83.67 %
 125          };
 126          
 127          const u16 light_pwm_duty_init_val_table[5] = {
 128              (u16)((u32)TIMER2_FEQ * 8367 / 10000), // 83.67 %
 129              (u16)((u32)TIMER2_FEQ * 7411 / 10000), // 74.11 %
 130              (u16)((u32)TIMER2_FEQ * 6455 / 10000), // 64.55 %
 131              (u16)((u32)TIMER2_FEQ * 5698 / 10000), // 56.98 %
 132              (u16)((u32)TIMER2_FEQ * 4980 / 10000), // 49.80 %
 133          };
 134          
 135          void led_pin_config(void)
 136          {
 137   1          P0_MD0 &= ~GPIO_P00_MODE_SEL(0x03);
 138   1          P0_MD0 |= GPIO_P00_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 139   1          FOUT_S00 = GPIO_FOUT_AF_FUNC;      // é€‰æ‹©AFåŠŸèƒ½è¾“å‡º
 140   1          P00 = 0;                           // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 141   1      
 142   1          P0_MD1 &= ~GPIO_P05_MODE_SEL(0x03);
 143   1          P0_MD1 |= GPIO_P05_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 144   1          FOUT_S05 = GPIO_FOUT_AF_FUNC;
 145   1          P05 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 146   1      
 147   1          P0_MD1 &= ~GPIO_P06_MODE_SEL(0x03);
 148   1          P0_MD1 |= GPIO_P06_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 149   1          FOUT_S06 = GPIO_FOUT_AF_FUNC;
 150   1          P06 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 151   1      
 152   1          P1_MD0 &= ~GPIO_P13_MODE_SEL(0x03);
 153   1          P1_MD0 |= GPIO_P13_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 154   1          FOUT_S13 = GPIO_FOUT_AF_FUNC;
 155   1          P13 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 156   1      
 157   1          P1_MD1 &= ~GPIO_P14_MODE_SEL(0x03);
 158   1          P1_MD1 |= GPIO_P14_MODE_SEL(0x01); // è¾“å‡ºæ¨¡å¼
 159   1          FOUT_S14 = GPIO_FOUT_AF_FUNC;
 160   1          P14 = 0; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 161   1      }
 162          
 163          /*
 164              å˜é‡ã€å‚æ•°ï¼Œåˆå§‹åŒ–
 165          
 166              å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä¸Šç”µï¼Œéœ€è¦è¯»å‡ºå­˜æ”¾çš„æ•°æ®
 167          */
 168          void param_init(void)
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 4   

 169          {
 170   1          light_ctl_phase_in_rate_1 = 1;
 171   1      
 172   1          cur_initial_discharge_gear = 5; // åˆå§‹æ”¾ç”µæŒ¡ä½ï¼ˆéœ€è¦è®°å¿†ï¼‰
 173   1          cur_discharge_rate = 2;         // åˆå§‹æ”¾ç”µé€Ÿç‡ï¼ˆéœ€è¦è®°å¿†ï¼‰
 174   1      }
 175          
 176          // å…³æœºï¼Œæœ€åè®©æŒ‡ç¤ºç¯ç†„ç­ï¼Œä¸»ç¯å…‰ç†„ç­ï¼Œå‡†å¤‡è¿›å…¥ä½åŠŸè€—
 177          void power_off(void)
 178          {
 179   1          flag_is_adjust_light_slowly = 0;      // å…³é—­ç¼“æ…¢è°ƒèŠ‚ä¸»ç¯å…‰çš„æ“ä½œ
 180   1          flag_is_auto_shutdown_enable = 0;     // ä¸ä½¿èƒ½è‡ªåŠ¨å…³æœº
 181   1          flag_is_auto_shutdown_times_come = 0; // æ¸…é™¤å®šæ—¶å…³æœºæ ‡å¿—
 182   1          led_status_clear();
 183   1          cur_led_mode = CUR_LED_MODE_OFF;
 184   1          cur_light_pwm_duty_val = 0;
 185   1          LIGHT_OFF();
 186   1      }
 187          
 188          void sleep_in(void)
 189          {
 190   1          SYS_CON6 |= SYS_MPDN_CNT(0x3);     // å…³é—­ç¨‹åºå­˜å‚¨å™¨ä¾›ç”µçš„å»¶è¿Ÿæ—¶é—´é…ç½®4ä¸ªç³»ç»Ÿå‘¨æœŸ
 191   1          SYS_CON7 = (SYS_EXT_SLP_CNT(0x3) | // é€€å‡ºä½åŠŸè€—å»¶è¿Ÿçš„æ—¶é—´é…ç½®å„é…å››ä¸ªç³»ç»Ÿå‘¨æœŸ
 192   1                      SYS_MTPUP_CNT(0x3) |
 193   1                      SYS_OPM_LDO_CNT(0x3) |
 194   1                      SYS_CLSM_LDO_CNT(0x3));
 195   1          SYS_CON8 |= SYS_LPSLP_DIS_ANA(0x1);   // æ‰“å¼€ä½åŠŸè€—sleep modeä¸€é”®å…³æ¨¡æ‹Ÿæ¨¡å—åŠŸèƒ½(å³å…³é—
             -­TK,AMP,CMP,ADCä¹‹ç±»çš„æ¨¡å—)
 196   1          CLK_XOSC &= ~(CLK_XOSC_LOW_EN(0x1) |  // å…³é—­32.768KHzä½é€Ÿæ™¶æŒ¯
 197   1                        CLK_XOSC_HIGH_EN(0x1)); // å…³é—­é«˜é€Ÿæ™¶æŒ¯
 198   1          LVD_CON0 &= ~(LVD_VCC_DETE_EN(0x1) |  // å…³é—­VCCç”µæºVCCç”µå‹ä½ç”µæ£€æµ‹åŠŸèƒ½
 199   1                        LVD_VDD_DETE_EN(0x1));  // å…³é—­1.5Væ•°å­—é€»è¾‘ç³»ç»Ÿå·¥ä½œç”µå‹VDDä½ç”µæ£€æµ‹åŠŸèƒ½
 200   1          PMU_CON2 &= ~0x70;                    // å…³é—­VPTAT_ADCè¾“å‡ºï¼Œå…³é—­æ¸©åº¦ä¼ æ„Ÿå™¨è¾“å‡ºVPTATï¼Œä¸
             -»LDOè¿‡æµæ¡£ä½é€‰æ‹©50mA
 201   1          CLK_CON0 &= ~CLK_SYSCLK_SEL(0x3);     // ç³»ç»Ÿæ—¶é’Ÿé€‰æ‹©rc64k
 202   1          FLASH_TIMEREG1 = 0x0;                 // é…ç½®LIRCæ—¶FLASHè®¿é—®é€Ÿåº¦
 203   1          PMU_CON0 &= ~0x60;                    // å…³é—­VDD PORæ¨¡å—, å…³é—­VBG06_REFè¾“å‡º
 204   1          CLK_ACON0 &= ~CLK_AIP_HRC_EN(0x1);    // å…³é—­HRCæ—¶é’Ÿ
 205   1          LP_CON = (LP_IDLE_EN(0x1) |
 206   1                    LP_SLEEP_GO_EN(0x1) | // Sleepä½åŠŸè€—æ¨¡å¼å”¤é†’åç»§ç»­è·‘åç»­ç¨‹åº
 207   1                  //   LP_GLIRC_EN(0x1) |    // å…³é—­RC64Kä½é€Ÿæ—¶é’Ÿï¼ˆWUTéœ€è¦æ ¹æ®è¿™ä¸ªæ—¶é’Ÿæ¥è¿›è¡Œè®
             -¡æ•°ï¼Œä¸èƒ½å…³é—­ï¼‰
 208   1                    LP_SLEEP_EN(0x1));    // ä½¿èƒ½ç¡çœ 
 209   1      }
 210          
 211          void sleep_out(void)
 212          {
 213   1          SYS_CON8 &= ~SYS_LPSLP_DIS_ANA(0x1); // å…³é—­ä½åŠŸè€—sleep modeä¸€é”®å…³æ¨¡æ‹Ÿæ¨¡å—åŠŸèƒ½(å³æ‰“å¼€
             -TK,AMP,CMP,ADCä¹‹ç±»çš„æ¨¡å—)
 214   1          PMU_CON0 |= 0x60;                    // ä½¿èƒ½VDD PORæ¨¡å—ï¼Œä½¿èƒ½VBG06_REFè¾“å‡º
 215   1          LVD_CON0 |= (LVD_VCC_DETE_EN(0x1) |  // ä½¿èƒ½VCCç”µæºVCCç”µå‹ä½ç”µæ£€æµ‹åŠŸèƒ½
 216   1                       LVD_VDD_DETE_EN(0x1));  // ä½¿èƒ½1.5Væ•°å­—é€»è¾‘ç³»ç»Ÿå·¥ä½œç”µå‹VDDä½ç”µæ£€æµ‹åŠŸèƒ½
 217   1          PMU_CON2 |= 0x70;                    // ä½¿èƒ½VPTAT_ADCè¾“å‡ºï¼Œä½¿èƒ½æ¸©åº¦ä¼ æ„Ÿå™¨è¾“å‡ºVPTATï¼Œä¸»
             -LDOè¿‡æµæ¡£ä½é€‰æ‹©100mA
 218   1          CLK_ACON0 |= CLK_AIP_HRC_EN(0x1);    // ä½¿èƒ½HRCæ—¶é’Ÿ
 219   1          LP_WKPND |= LP_WKUP_0_PCLR(0x1);     // æ¸…é™¤é€šé“0å”¤é†’æ ‡å¿—ä½
 220   1          FLASH_TIMEREG1 = 0x58;               // FLASHè®¿é—®é€Ÿåº¦ = ç³»ç»Ÿæ—¶é’Ÿ/3
 221   1          CLK_CON0 |= CLK_SYSCLK_SEL(0x3);     // ç³»ç»Ÿæ—¶é’Ÿé€‰æ‹©hirc_clk
 222   1      }
 223          
 224          // ä½åŠŸè€—
 225          void low_energy(void)
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 5   

 226          {
 227   1      #define WUT_PERIOD_VAL (SYSCLK / 64 / 3000 - 1)
 228   1          // if (CUR_LED_MODE_OFF != cur_charge_phase || /* æŒ‡ç¤ºç¯æ²¡æœ‰å…³é—­ */
 229   1          //     0 != cur_light_pwm_duty_val)            /* ä¸»ç¯å…‰çš„å ç©ºæ¯”ä¸ä¸º0 */
 230   1          // {
 231   1          //     // ä¸æ»¡è¶³è¿›å…¥ä½åŠŸè€—çš„æ¡ä»¶ï¼Œé€€å‡º
 232   1          //     return;
 233   1          // }
 234   1      
 235   1          printf("sleep\n");
 236   1          /*
 237   1              é…ç½®å”¤é†’æºï¼Œ
 238   1              çº¢å¤–æ¥æ”¶ï¼Œæœ‰ä½ç”µå¹³å°±å”¤é†’ï¼Œè¿æ¥åˆ°å”¤é†’é€šé“0
 239   1              å……ç”µç”µå‹ å¤§äº 4.9V å”¤é†’
 240   1      
 241   1              ä½¿ç”¨å®šæ—¶å”¤é†’ï¼Œå”¤é†’åæ£€æµ‹ä¸€æ¬¡å……ç”µç”µå‹ï¼Œå¦‚æœå°äº4.9Vï¼Œå›åˆ°ä½åŠŸè€—
 242   1          */
 243   1          FIN_S10 = 0x14; // å”¤é†’é€šé“0é€‰æ‹© çº¢å¤–æ¥æ”¶å¼•è„š
 244   1      
 245   1          // é…ç½®å®šæ—¶å”¤é†’ï¼š
 246   1          // è®¾ç½®WUTçš„è®¡æ•°åŠŸèƒ½ï¼Œé…ç½®ä¸€ä¸ª3000msçš„ä¸­æ–­
 247   1          __EnableIRQ(WUT_IRQn);         // ä½¿èƒ½WUTä¸­æ–­
 248   1          IE_EA = 1;                     // ä½¿èƒ½æ€»ä¸­æ–­
 249   1          TMR_ALLCON = WUT_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
 250   1          WUT_PRH = TMR_PERIOD_VAL_H(((3000 - 1) >> 8) & 0xFF); // å‘¨æœŸå€¼
 251   1          WUT_PRL = TMR_PERIOD_VAL_L(((3000 - 1) >> 0) & 0xFF);
 252   1          // WUT_PRH = TMR_PERIOD_VAL_H((WUT_PERIOD_VAL >> 8) & 0xFF); // å‘¨æœŸå€¼
 253   1          // WUT_PRL = TMR_PERIOD_VAL_L((WUT_PERIOD_VAL >> 0) & 0xFF);
 254   1          WUT_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // ä½¿èƒ½å”¤é†’å®šæ—¶å™¨
 255   1          WUT_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x6) | TMR_MODE_SEL(0x1); // é€‰æ‹©ç³»ç»Ÿæ—¶é’Ÿï¼Œ64
             -åˆ†é¢‘ï¼Œè®¡æ•°æ¨¡å¼
 256   1      
 257   1          LP_CON &= ~LP_ISD_DIS_LP_EN(0x01); // ä½¿èƒ½ISDæ¨¡å¼ä¸‹ä½åŠŸè€—åŠŸèƒ½
 258   1          LP_WKPND = LP_WKUP_0_PCLR(0x01) |  /* æ¸…é™¤å”¤é†’æ ‡å¿—ä½ */
 259   1                     LP_WKUP_2_PCLR(0x1);    /* æ¸…é™¤å”¤é†’æ ‡å¿—ä½ */
 260   1          LP_WKCON = (LP_WKUP_0_EDG(0x01) |  /* é€šé“0ä½ç”µå¹³è§¦å‘å”¤é†’ */
 261   1                      LP_WKUP_0_EN(0x01) |   /* å”¤é†’é€šé“0ä½¿èƒ½ */
 262   1                      LP_WKUP_2_EDG(0x0) |   /* é€šé“2é«˜ç”µå¹³è§¦å‘å”¤é†’ */
 263   1                      LP_WKUP_2_EN(0x1));    /* å”¤é†’é€šé“2ä½¿èƒ½ï¼ˆWUTå”¤é†’åªèƒ½æ˜¯å”¤é†’é€šé“2ï¼‰ */
 264   1      
 265   1          sleep_in();
 266   1          sleep_out();
 267   1      
 268   1          /* å”¤é†’åï¼Œå…³é—­å”¤é†’æº */
 269   1          LP_WKCON &= ~LP_WKUP_0_EN(0x01); // å”¤é†’é€šé“0ä¸ä½¿èƒ½
 270   1      
 271   1          printf("wake up\n");
 272   1      }
 273          
 274          /**
 275           * @brief  Main program.
 276           * @param  None
 277           * @retval None
 278           */
 279          void main(void)
 280          {
 281   1          // çœ‹é—¨ç‹—é»˜è®¤æ‰“å¼€, å¤ä½æ—¶é—´2s
 282   1          WDT_KEY = WDT_KEY_VAL(0xDD); //  å…³é—­çœ‹é—¨ç‹— (å¦‚éœ€é…ç½®çœ‹é—¨ç‹—è¯·æŸ¥çœ‹â€œWDT\WDT_Resetâ€ç¤º
             -ä¾‹)
 283   1      
 284   1          system_init();
 285   1      
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 6   

 286   1          // å…³é—­HCKå’ŒHDAçš„è°ƒè¯•åŠŸèƒ½
 287   1          WDT_KEY = 0x55;  // è§£é™¤å†™ä¿æŠ¤
 288   1          IO_MAP &= ~0x01; // æ¸…é™¤è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå®ç°å…³é—­HCKå’ŒHDAå¼•è„šçš„è°ƒè¯•åŠŸèƒ½ï¼ˆè§£é™¤æ
             -˜ å°„ï¼‰
 289   1          WDT_KEY = 0xBB;  // å†™ä¸€ä¸ªæ— æ•ˆçš„æ•°æ®ï¼Œè§¦å‘å†™ä¿æŠ¤
 290   1      
 291   1          uart0_config();
 292   1          // my_debug_led_config();
 293   1      
 294   1          timer0_config();
 295   1          timer1_pwm_config(); // æ§åˆ¶å……ç”µçš„PWM
 296   1          timer1_pwm_disable();
 297   1          timer2_pwm_config(); // æ§åˆ¶ç¯å…‰çš„pwm
 298   1          timer2_pwm_disable();
 299   1      
 300   1          // timer1_set_pwm_high_feq();
 301   1          // TODO: 7361ä¸ç”¨åŠ è¿™ä¸ªå¼•è„šé…ç½®:
 302   1          led_pin_config();
 303   1      
 304   1          // çº¢å¤–æ¥æ”¶å¼•è„šï¼š
 305   1          P2_MD0 &= ~(GPIO_P23_MODE_SEL(0x03)); // è¾“å…¥æ¨¡å¼
 306   1          P2_PU |= GPIO_P23_PULL_UP(0x01);      // ä¸Šæ‹‰
 307   1      
 308   1          adc_config();
 309   1      
 310   1          // printf("sys reset\n"); // æ‰“å°è‡³å°‘å ç”¨1012å­—èŠ‚ç©ºé—´
 311   1      
 312   1          // TODO:
 313   1          // ä¸Šç”µåï¼Œéœ€è¦å…ˆç‚¹äº®çº¢è‰²æŒ‡ç¤ºç¯ï¼Œå†å˜ä¸ºç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 314   1          LED_1_ON();
 315   1          delay_ms(1000);
 316   1      
 317   1          // cur_led_mode = CUR_LED_MODE_INITIAL_DISCHARGE_GEAR;
 318   1      
 319   1      #if 0
                  cur_led_mode = CUR_LED_MODE_BAT_INDICATOR; // ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
                  cur_initial_discharge_gear = 5;
                  cur_discharge_rate = 3;
              #endif
 324   1      
 325   1          // cur_led_mode = CUR_LED_MODE_CHARGING;
 326   1      
 327   1          // bat_adc_val = 2000;
 328   1          // led_status_refresh();
 329   1          // cur_led_mode = CUR_LED_MODE_BAT_INDICATOR;
 330   1      
 331   1          param_init();
 332   1      
 333   1          light_init();
 334   1          led_init();
 335   1          led_mode_alter(CUR_LED_MODE_BAT_INDICATOR); // ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
 336   1      
 337   1          // light_ctl_blink_times = 3;
 338   1          // flag_is_ctl_light_blink = 1;
 339   1      
 340   1          printf("sys reset\n");
 341   1      
 342   1          while (1)
 343   1          {
 344   2              low_energy();
 345   2      
 346   2      #if 0
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 7   

              
                      /* åœ¨æ”¾ç”µæ—¶ï¼Œæ£€æµ‹ç”µæ± ç”µå‹ï¼Œä¸€æ—¦ä½äº2.5Vï¼Œç›´æ¥å…³æœº */
                      if (cur_charge_phase == CUR_CHARGE_PHASE_NONE || /* å¦‚æœä¸åœ¨å……ç”µ */
                          cur_led_mode != CUR_LED_MODE_OFF)            /* å¦‚æœledæŒ‡ç¤ºç¯è¿˜æœªå…³é—­ */
                      {
                          /*
                              å¦‚æœè¿›å…¥è¯¥æ¡ä»¶ï¼Œå¯èƒ½æ­£åœ¨æ”¾ç”µï¼Œæ£€æµ‹ç”µæ± ç”µå‹ï¼Œä¸€æ—¦ä½äº2.5Vï¼Œç›´æ
             -¥å…³æœº
                          */
                          adc_update_bat_adc_val();
                          // ç”µæ± ç”µå‹æ£€æµ‹è„šæ£€æµ‹åˆ°çš„ç”µå‹ï¼Œæ˜¯ç”µæ± çš„1/2åˆ†å‹ï¼Œadcä½¿ç”¨2Vå‚è€ƒç”µå‹
                          if (bat_adc_val < (u16)((u32)2500 * 4096 / 2 / 2 / 1000))
                          {
                              power_off();
                          }
                      }
              
              
                      charge_handle();
                      ir_handle(); // å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­æ˜¯å¦åœ¨å……ç”µï¼Œå¦‚æœåœ¨å……ç”µåˆ™é€€å‡º
              
                      /*
                          ã€éå……ç”µæ¨¡å¼ã€‘ -> ã€å……ç”µæ¨¡å¼ã€‘
              
                          å¦‚æœå½“å‰æ­£åœ¨å……ç”µï¼Œä½†æ˜¯æŒ‡ç¤ºç¯æ²¡æœ‰åˆ‡æ¢åˆ°å……ç”µæŒ‡ç¤ºæ¨¡å¼ï¼Œåˆ™åˆ‡æ¢ï¼š
                      */
                      if (CUR_CHARGE_PHASE_NONE != cur_charge_phase)
                      {
                          // if (cur_led_mode != CUR_LED_MODE_CHARGING && /* æŒ‡ç¤ºç¯ä¸å¤„äºå……ç”µæ¨¡å¼ */
                          //     cur_led_mode != CUR_LED_MODE_OFF)
                          if (cur_led_mode != CUR_LED_MODE_CHARGING) /* æŒ‡ç¤ºç¯ä¸å¤„äºå……ç”µæ¨¡å¼ */
                          {
                              // æ¸…ç©ºå®šæ—¶å…³æœºç›¸å…³çš„å˜é‡
                              flag_is_auto_shutdown_enable = 0;
                              led_status_clear();
                              led_mode_alter(CUR_LED_MODE_CHARGING);
                          }
              
                          // éœ€è¦å…³é—­ä¸»ç¯å…‰
                          LIGHT_OFF();
                      } // if (CUR_CHARGE_PHASE_NONE != cur_charge_phase)
                      else // CUR_CHARGE_PHASE_NONE == cur_charge_phase
                      {
                          /*
                              ã€å……ç”µæ¨¡å¼ã€‘ -> ã€æ”¾ç”µã€ç‚¹äº®ä¸»ç¯å…‰ã€æŒ‡ç¤ºç¯å¯¹åº”ç”µæ± ç”µé‡æŒ‡ç¤ºã€‘
                              å¦‚æœå½“å‰æ²¡æœ‰åœ¨å……ç”µï¼Œå¹¶ä¸”æŒ‡ç¤ºç¯å¤„äºå……ç”µæŒ‡ç¤ºæ¨¡å¼ï¼Œ
                              åˆ‡æ¢å›ç”µæ± ç”µé‡æŒ‡ç¤ºæ¨¡å¼
              
                              æµ‹è¯•æ—¶å‘ç°ä»å……ç”µåˆ°æ–­å¼€å……ç”µï¼ŒledæŒ‡ç¤ºç¯è¿˜åœ¨é—ªçƒï¼Œéœ€è¦åŠ ä¸Šè¿™è¡¥ä¸
                          */
                          if (cur_led_mode == CUR_LED_MODE_CHARGING)
                          {
                              led_status_clear();
                              led_mode_alter(CUR_LED_MODE_BAT_INDICATOR);
                              // éœ€è¦æ‰“å¼€ä¸»ç¯å…‰
              
                              // æŸ¥è¡¨ï¼Œè·å¾—æŒ¡ä½å¯¹åº”çš„å ç©ºæ¯”å€¼
                              cur_light_pwm_duty_val = light_pwm_duty_init_val_table[cur_initial_discharge_gear - 1];
              
                              LIGHT_SET_PWM_DUTY(cur_light_pwm_duty_val); // ç«‹åˆ»æ›´æ–°PWMå ç©ºæ¯”
                              LIGHT_ON();                                 // ä½¿èƒ½ PWM è¾“å‡º
                          }
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 8   

                      }
              
                      // å¦‚æœå®šæ—¶å…³æœºçš„æ—¶é—´åˆ°æ¥
                      if (flag_is_auto_shutdown_times_come)
                      {
                          // flag_is_auto_shutdown_times_come = 0; // æ¸…ç©ºå®šæ—¶å…³æœºæ ‡å¿—
                          // flag_is_auto_shutdown_enable = 0;     // ä¸å…è®¸è‡ªåŠ¨å…³æœº
                          // led_status_clear();
                          // cur_led_mode = CUR_LED_MODE_OFF;
                          // cur_light_pwm_duty_val = 0;
                          // LIGHT_OFF();
                          power_off();
                          // printf("power off\n");
                      }
              
                      adc_update_bat_adc_val();
                      led_handle();
                      light_handle();
              
              #if 0  // æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯ï¼š
              
                      {
                          static u8 cnt = 0;
                          cnt++;
                          if (cnt >= 200)
                          {
                              cnt = 0;
                              // printf("bat_adc_val %u\n", bat_adc_val);
                              // printf("cur_light_pwm_duty_val %u\n", cur_light_pwm_duty_val);
                              // printf("cur light pwm percent %bu %%\n", (u8)((u32)cur_light_pwm_duty_val * 100 / TIMER
             -2_FEQ));
              
                              switch (cur_led_mode)
                              {
                              case CUR_LED_MODE_OFF:
                                  printf("led mode off\n");
                                  break;
              
                              case CUR_LED_MODE_BAT_INDICATOR:
                                  printf("led mode bat indicator\n");
                                  break;
              
                              case CUR_LED_MODE_CHARGING:
                                  printf("led mode charging\n");
                                  break;
              
                              case CUR_LED_MODE_SETTING:
                                  printf("led mode setting\n");
                                  break;
              
                              case CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE:
                                  printf("led mode initial discharge gear in setting mode\n");
                                  break;
              
                              case CUR_LED_MODE_DISCHARGE_RATE_IN_SETTING_MODE:
                                  printf("led mode discharge rate in setting mode\n");
                                  break;
              
                              case CUR_LED_MODE_BAT_INDICATIOR_IN_INSTRUCTION_MODE:
                                  printf("led mode bat indicator in instruction mode\n");
                                  break;
              
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 9   

                              case CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_INSTRUCTION_MODE:
                                  printf("led mode initial discharge gear in instruction mode\n");
                                  break;
              
                              case CUR_LED_MODE_DISCHARGE_RATE_IN_INSTRUCTION_MODE:
                                  printf("led mode discharge rate in instruction mode\n");
                                  break;
              
                              default:
                                  break;
                              }
                          }
                      }
              #endif // æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯
              
              #if 0  // demoæ¿ä½¿ç”¨åˆ°çš„è°ƒè¯•æŒ‡ç¤ºç¯
                      if (CUR_CHARGE_PHASE_NONE == cur_charge_phase)
                      {
                          my_debug_led_2_off();
                          my_debug_led_3_off();
                          my_debug_led_4_off();
              
                          my_debug_led_1_on();
                      }
                      else if (CUR_CHARGE_PHASE_NORMAL_CHARGE == cur_charge_phase)
                      {
                          my_debug_led_1_off();
                          my_debug_led_3_off();
                          my_debug_led_4_off();
              
                          my_debug_led_2_on();
                      }
                      else if (CUR_CHARGE_PHASE_TRICKLE_CHARGE_WHEN_APPROACH_FULLY_CHARGE == cur_charge_phase)
                      {
                          my_debug_led_1_off();
                          my_debug_led_2_off();
                          my_debug_led_4_off();
              
                          my_debug_led_3_on();
                      }
                      else if (CUR_CHARGE_PHASE_FULLY_CHARGE == cur_charge_phase)
                      {
                          my_debug_led_1_off();
                          my_debug_led_2_off();
                          my_debug_led_3_off();
              
                          my_debug_led_4_on();
                      }
              #endif // demoæ¿ä½¿ç”¨åˆ°çš„è°ƒè¯•æŒ‡ç¤ºç¯
              
              #endif
 520   2          }
 521   1      }
 522          
 523          /**
 524           * @}
 525           */
 526          
 527          /*************************** (C) COPYRIGHT 2021 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.60.7.0   MAIN                                                              08/08/2025 17:58:56 PAGE 10  

   CODE SIZE        =    398    ----
   CONSTANT SIZE    =     27    ----
   XDATA SIZE       =     84    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     16    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
