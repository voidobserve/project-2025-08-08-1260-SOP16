C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TIMER0
OBJECT MODULE PLACED IN .\Release\Objects\timer0.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\HardWare\timer0.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C)
                    - INCDIR(..\..\Libraries\Include;..\..\User;..\..\HardWare) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\timer
                    -0.lst) OBJECT(.\Release\Objects\timer0.obj)

line level    source

   1          #include "timer0.h"
   2          
   3          #include "ir_handle.h"
   4          #include "user_config.h"
   5          
   6          void timer0_config(void)
   7          {
   8   1          __EnableIRQ(TMR0_IRQn); // ä½¿èƒ½timer0ä¸­æ–­
   9   1          IE_EA = 1;              // ä½¿èƒ½æ€»ä¸­æ–­
  10   1      
  11   1          // è®¾ç½®timer0çš„è®¡æ•°åŠŸèƒ½ï¼Œé…ç½®ä¸€ä¸ªé¢‘ç‡ä¸º1kHzçš„ä¸­æ–­
  12   1          TMR_ALLCON = TMR0_CNT_CLR(0x1);                               // æ¸…é™¤è®¡æ•°å€¼
  13   1          TMR0_PRH = TMR_PERIOD_VAL_H((TIMER0_PERIOD_VAL >> 8) & 0xFF); // å‘¨æœŸå€¼
  14   1          TMR0_PRL = TMR_PERIOD_VAL_L((TIMER0_PERIOD_VAL >> 0) & 0xFF);
  15   1          TMR0_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // è®¡æ•°ç­‰äºå‘¨æœŸæ—¶å
             -…è®¸å‘ç”Ÿä¸­æ–­
  16   1          TMR0_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x1); // é€‰æ‹©ç³»ç»Ÿæ—¶é’Ÿï¼Œ1
             -28åˆ†é¢‘ï¼Œè®¡æ•°æ¨¡å¼
  17   1      }
  18          
  19          void TIMR0_IRQHandler(void) interrupt TMR0_IRQn
  20          {
  21   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
  22   1          __IRQnIPnPush(TMR0_IRQn);
  23   1      
  24   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
  25   1      
  26   1          // å‘¨æœŸä¸­æ–­
  27   1          if (TMR0_CONH & TMR_PRD_PND(0x1))
  28   1          {
  29   2              TMR0_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
  30   2      
  31   2      #if 1     // çº¢å¤–è§£ç ã€éœ€è¦æ”¾åˆ°100usçš„å®šæ—¶å™¨ä¸­æ–­æ¥å¤„ç†ã€‘
  32   2              { // çº¢å¤–è§£ç 
  33   3                  // static volatile u8 ir_fliter;
  34   3                  static volatile u16 ir_level_cnt; // çº¢å¤–ä¿¡å·çš„ä¸‹é™æ²¿æ—¶é—´é—´éš”è®¡æ•°
  35   3                  static volatile u32 __ir_data;    //
  36   3                  static volatile bit last_level_in_ir_pin = 0;
  37   3                  // static volatile u16 ir_long_press_cnt; // æª¢æ¸¬ç´…å¤–é™æ§é•·æŒ‰çš„è¨ˆæ•¸å€¼
  38   3      
  39   3                  // å¯¹æ¯ä¸ªä¸‹é™æ²¿è¿›è¡Œè®¡æ•°
  40   3                  if (ir_level_cnt <= 1300)
  41   3                      ir_level_cnt++;
  42   3      
  43   3                  // æ»¤æ³¢æ“ä½œ
  44   3                  // ir_fliter <<= 1;
  45   3                  // if (IR_RECV_PIN)
  46   3                  // {
  47   3                  //     ir_fliter |= 1;
  48   3                  // }
  49   3                  // ir_fliter &= 0x07;
  50   3      
  51   3                  // if (ir_fliter == 0x07)
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 2   

  52   3                  //     filter_level = 1;
  53   3                  // else if (ir_fliter == 0x00)
  54   3                  //     filter_level = 0;
  55   3      
  56   3                  // if (filter_level)
  57   3                  if (IR_RECV_PIN)
  58   3                  {
  59   4                      last_level_in_ir_pin = 1; // è¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯é«˜ç”µå¹³
  60   4      
  61   4                      // å¦‚æœä¹‹å‰ä¹Ÿæ˜¯é«˜ç”µå¹³
  62   4                      if (ir_level_cnt > 1200) // è¶…æ—¶æ—¶é—´(120000us,120ms)
  63   4                      {
  64   5                          // if (__ir_data != 0) // è¶…æ—¶ï¼Œä¸”æ¥æ”¶åˆ°æ•°æ®(çº¢å¤–æ¥æ”¶å¤„ç†å‡½æ•°ä¸­ä¼šæŠ
             -Šir_dataæ¸…é›¶)
  65   5                          if (__ir_data != 0) // è¶…æ—¶ï¼Œä¸”æ¥æ”¶åˆ°æ•°æ®(ç°åœ¨æ˜¯åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­æŠ
             -Š__ir_dataè‡ªåŠ¨æ¸…é›¶)
  66   5                          {
  67   6                              // // å¸¦æ ¡éªŒçš„ç‰ˆæœ¬ï¼š
  68   6                              // if ((u8)(__ir_data >> 8) == (u8)(~__ir_data)) // å¦‚æœé”®å€¼çš„åŸç å’Œåç 
             -ç›¸ç­‰
  69   6                              // {
  70   6                              // flag_is_recved_data = 1;
  71   6                              // }
  72   6      
  73   6                              // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
  74   6                              if (0 == flag_is_recved_data)
  75   6                              {
  76   7                                  // if ((__ir_data & 0xFF0000) == 0xFF0000)
  77   7                                  {
  78   8                                      ir_data = ~__ir_data;
  79   8                                      __ir_data = 0;
  80   8                                      flag_is_recved_data = 1;
  81   8                                  }
  82   7                              }
  83   6                          }
  84   5      
  85   5                          flag_is_recv_ir_repeat_code = 0; // è®¤ä¸ºé¥æ§å™¨æŒ‰é”®å·²ç»æŒ‰ä¸‹ï¼Œç„¶åæ¾å¼€
  86   5                      }
  87   4                  }
  88   3                  else
  89   3                  {
  90   4                      if (last_level_in_ir_pin)
  91   4                      {
  92   5                          // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°çš„æ˜¯é«˜ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°äº†ä½ç”µå¹³
  93   5                          if (ir_level_cnt <= 8) // å°äº800usï¼Œè¯´æ˜æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®ï¼Œé‡æ–°æ¥æ”¶
  94   5                          {
  95   6                              // FLAG_IS_RECVED_ERR_IR_DATA = 1;
  96   6                              flag_is_recv_ir_repeat_code = 0;
  97   6                          }
  98   5                          else if (ir_level_cnt <= 18) // å°äº1800us,è¯´æ˜æ¥æ”¶åˆ°äº†é€»è¾‘0
  99   5                          {
 100   6                              __ir_data <<= 1;
 101   6      
 102   6                              // P15D = 0; // æµ‹è¯•çº¢å¤–è§£ç 
 103   6                              // P15D = ~P15D; // æµ‹è¯•çº¢å¤–è§£ç 
 104   6                          }
 105   5                          else if (ir_level_cnt <= 26) // å°äº2600us,è¯´æ˜æ¥æ”¶åˆ°äº†é€»è¾‘1
 106   5                          {
 107   6                              __ir_data <<= 1;
 108   6                              __ir_data |= 0x01;
 109   6      
 110   6                              // P15D = 1; // æµ‹è¯•çº¢å¤–è§£ç 
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 3   

 111   6                          }
 112   5                          else if (ir_level_cnt <= 150) // å°äº15000us,è¯´æ˜æ¥æ”¶åˆ°äº†æ ¼å¼å¤´
 113   5                          {
 114   6                              // FLAG_IS_RECVED_ERR_IR_DATA = 1;
 115   6                              // ir_long_press_cnt = 0; // åŠ ä¸Šè¿™ä¸€æ¡ä¼šæ£€æµ‹ä¸åˆ°é•¿æŒ‰
 116   6                          }
 117   5                          else if (ir_level_cnt <= 420) // å°äº42ms,è¯´æ˜æ¥æ”¶å®Œä¸€æ¬¡å®Œæ•´çš„çº¢å¤–ä¿¡å·
 118   5                          {
 119   6      #if 0 // å¸¦æ ¡éªŒçš„ç‰ˆæœ¬ï¼Œå‘½ä»¤æºç ä¸å‘½ä»¤åç è¿›è¡Œæ ¡éªŒ
                  
                              if ((u8)(__ir_data >> 8) == (u8)(~__ir_data)) // å¦‚æœé”®å€¼çš„åŸç å’Œåç ç›¸ç­‰
                              {
                                  flag_is_recved_data = 1;
                                  flag_is_recv_ir_repeat_code = 1; //
                                  ir_long_press_cnt = 0;
                              }
              
              #else // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
 129   6      
 130   6                              if (0 == flag_is_recved_data) // å¦‚æœä¹‹å‰æœªæ¥æ”¶åˆ°æ•°æ®/æ¥æ”¶åˆ°çš„æ•°æ®
             -å·²ç»å¤„ç†å®Œæ¯•
 131   6                              {
 132   7                                  // if ((__ir_data & 0xFF0000) == 0xFF0000)
 133   7                                  {
 134   8                                      ir_data = ~__ir_data;
 135   8                                      __ir_data = 0;
 136   8                                      flag_is_recved_data = 1;
 137   8                                      // flag_is_recv_ir_repeat_code = 1; //
 138   8                                  }
 139   7                              }
 140   6      
 141   6      #endif // ä¸å¸¦æ ¡éªŒçš„ç‰ˆæœ¬
 142   6                          }
 143   5                          else if (ir_level_cnt <= 1200) // å°äº120000,120ms,è¯´æ˜æ¥æ”¶åˆ°äº†é‡å¤ç 
 144   5                          {
 145   6                              // if (ir_long_press_cnt < 65535)
 146   6                              //     ir_long_press_cnt++;
 147   6      
 148   6                              flag_is_recv_ir_repeat_code = 1;
 149   6                          }
 150   5                          // else // è¶…è¿‡120000,è¯´æ˜æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®
 151   5                          // {
 152   5                          // }
 153   5      
 154   5                          ir_level_cnt = 0;
 155   5                      }
 156   4      
 157   4                      last_level_in_ir_pin = 0; // è¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯ä½ç”µå¹³
 158   4                  }
 159   3              } // çº¢å¤–è§£ç 
 160   2      #endif // çº¢å¤–è§£ç ã€éœ€è¦æ”¾åˆ°100usçš„å®šæ—¶å™¨ä¸­æ–­æ¥å¤„ç†ã€‘
 161   2      
 162   2      #if 1 // æ§åˆ¶LEDæŒ‡ç¤ºç¯ (è½¯ä»¶PWMé©±åŠ¨)
 163   2      
 164   2              {                   // æ§åˆ¶LEDæŒ‡ç¤ºç¯--éœ€è¦æ”¾åœ¨100usçš„ä¸­æ–­
 165   3                  static u16 cnt; // ç”¨è½¯ä»¶å®ç°PWMé©±åŠ¨LEDçš„ç›¸å…³å˜é‡
 166   3                  cnt++;
 167   3      
 168   3                  if (cnt <= 20) // 20 * 100us
 169   3                  {
 170   4                      if (flag_is_led_1_enable)
 171   4                      {
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 4   

 172   5                          LED_1_PIN = LED_ON_LEVEL;
 173   5                      }
 174   4      
 175   4                      if (flag_is_led_2_enable)
 176   4                      {
 177   5                          LED_2_PIN = LED_ON_LEVEL;
 178   5                      }
 179   4      
 180   4                      if (flag_is_led_3_enable)
 181   4                      {
 182   5                          LED_3_PIN = LED_ON_LEVEL;
 183   5                      }
 184   4      
 185   4                      if (flag_is_led_4_enable)
 186   4                      {
 187   5                          LED_4_PIN = LED_ON_LEVEL;
 188   5                      }
 189   4      
 190   4                      if (flag_is_led_5_enable)
 191   4                      {
 192   5                          LED_5_PIN = LED_ON_LEVEL;
 193   5                      }
 194   4                  }
 195   3                  else
 196   3                  {
 197   4                      LED_1_PIN = LED_OFF_LEVEL;
 198   4                      LED_2_PIN = LED_OFF_LEVEL;
 199   4                      LED_3_PIN = LED_OFF_LEVEL;
 200   4                      LED_4_PIN = LED_OFF_LEVEL;
 201   4                      LED_5_PIN = LED_OFF_LEVEL;
 202   4                  }
 203   3      
 204   3                  if (cnt >= 100) // 100 * 100us
 205   3                  {
 206   4                      cnt = 0;
 207   4                  }
 208   3      
 209   3              } // æ§åˆ¶LEDæŒ‡ç¤ºç¯--éœ€è¦æ”¾åœ¨100usçš„ä¸­æ–­
 210   2      
 211   2      #endif // æ§åˆ¶LEDæŒ‡ç¤ºç¯(è½¯ä»¶PWMé©±åŠ¨)
 212   2      
 213   2              {
 214   3                  static u8 cnt_100us = 0;
 215   3                  cnt_100us++;
 216   3      
 217   3                  if (cnt_100us >= 10) // 10 * 100us == 1ms
 218   3                  {
 219   4                      cnt_100us = 0;
 220   4      
 221   4      #if 1 // æ§åˆ¶LEDæŒ‡ç¤ºç¯çš„é—ªçƒæ•ˆæœ
 222   4      
 223   4                      {
 224   5                          static u8 blink_cnt = 0;
 225   5                          static bit flag_blink_dir = 0;
 226   5                          blink_cnt++;
 227   5                          if (blink_cnt >= 200)
 228   5                          {
 229   6                              blink_cnt = 0;
 230   6      
 231   6                              // å¤„äºåˆå§‹æ”¾ç”µæŒ¡ä½æŒ‡ç¤ºæ¨¡å¼ï¼Œæ‰è¿›å…¥
 232   6                              if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_SETTING_MODE == cur_led_mode ||
 233   6                                  CUR_LED_MODE_INITIAL_DISCHARGE_GEAR_IN_INSTRUCTION_MODE == cur_led_mode)
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 5   

 234   6                              {
 235   7                                  if (0 == flag_blink_dir)
 236   7                                  {
 237   8                                      switch (cur_initial_discharge_gear)
 238   8                                      {
 239   9                                      case 1:
 240   9                                          LED_1_ON();
 241   9                                          break;
 242   9                                      case 2:
 243   9                                          LED_2_ON();
 244   9                                          break;
 245   9                                      case 3:
 246   9                                          LED_3_ON();
 247   9                                          break;
 248   9                                      case 4:
 249   9                                          LED_4_ON();
 250   9                                          break;
 251   9                                      case 5:
 252   9                                          LED_5_ON();
 253   9                                          break;
 254   9                                      }
 255   8      
 256   8                                      flag_blink_dir = 1;
 257   8                                  }
 258   7                                  else
 259   7                                  {
 260   8                                      switch (cur_initial_discharge_gear)
 261   8                                      {
 262   9                                      case 1:
 263   9                                          LED_1_OFF();
 264   9                                          break;
 265   9                                      case 2:
 266   9                                          LED_2_OFF();
 267   9                                          break;
 268   9                                      case 3:
 269   9                                          LED_3_OFF();
 270   9                                          break;
 271   9                                      case 4:
 272   9                                          LED_4_OFF();
 273   9                                          break;
 274   9                                      case 5:
 275   9                                          LED_5_OFF();
 276   9                                          break;
 277   9                                      }
 278   8      
 279   8                                      flag_blink_dir = 0;
 280   8                                  }
 281   7                              } // if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR == cur_led_mode)
 282   6                              else if (CUR_LED_MODE_SETTING == cur_led_mode)
 283   6                              {
 284   7                                  // åˆšæŒ‰ä¸‹é¥æ§å™¨çš„ SET æŒ‰é”®ï¼Œä¼šè¿›å…¥ è®¾ç½®æ¨¡å¼ï¼Œ5ä¸ªæŒ‡ç¤ºç¯ä¸
             -€èµ·é—ªçƒ
 285   7                                  if (0 == flag_blink_dir)
 286   7                                  {
 287   8                                      LED_1_ON();
 288   8                                      LED_2_ON();
 289   8                                      LED_3_ON();
 290   8                                      LED_4_ON();
 291   8                                      LED_5_ON();
 292   8                                      flag_blink_dir = 1;
 293   8                                  }
 294   7                                  else
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 6   

 295   7                                  {
 296   8                                      LED_1_OFF();
 297   8                                      LED_2_OFF();
 298   8                                      LED_3_OFF();
 299   8                                      LED_4_OFF();
 300   8                                      LED_5_OFF();
 301   8                                      flag_blink_dir = 0;
 302   8                                  }
 303   7                              }
 304   6                              // æŒ‡ç¤ºç¯å¤„äºå……ç”µæŒ‡ç¤ºæ¨¡å¼
 305   6                              else if (CUR_LED_MODE_CHARGING == cur_led_mode)
 306   6                              {
 307   7                                  if (cur_led_gear_in_charging <= 2)
 308   7                                  {
 309   8                                      if (0 == flag_blink_dir)
 310   8                                      {
 311   9                                          LED_2_ON();
 312   9                                          flag_blink_dir = 1;
 313   9                                      }
 314   8                                      else
 315   8                                      {
 316   9                                          LED_2_OFF();
 317   9                                          flag_blink_dir = 0;
 318   9                                      }
 319   8                                  }
 320   7                                  else if (cur_led_gear_in_charging <= 3)
 321   7                                  {
 322   8                                      if (0 == flag_blink_dir)
 323   8                                      {
 324   9                                          LED_3_ON();
 325   9                                          flag_blink_dir = 1;
 326   9                                      }
 327   8                                      else
 328   8                                      {
 329   9                                          LED_3_OFF();
 330   9                                          flag_blink_dir = 0;
 331   9                                      }
 332   8                                  }
 333   7                                  else if (cur_led_gear_in_charging <= 4)
 334   7                                  {
 335   8                                      if (0 == flag_blink_dir)
 336   8                                      {
 337   9                                          LED_4_ON();
 338   9                                          flag_blink_dir = 1;
 339   9                                      }
 340   8                                      else
 341   8                                      {
 342   9                                          LED_4_OFF();
 343   9                                          flag_blink_dir = 0;
 344   9                                      }
 345   8                                  }
 346   7                                  else if (cur_led_gear_in_charging <= 5)
 347   7                                  {
 348   8                                      if (0 == flag_blink_dir)
 349   8                                      {
 350   9                                          LED_5_ON();
 351   9                                          flag_blink_dir = 1;
 352   9                                      }
 353   8                                      else
 354   8                                      {
 355   9                                          LED_5_OFF();
 356   9                                          flag_blink_dir = 0;
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 7   

 357   9                                      }
 358   8                                  }
 359   7                              }
 360   6      
 361   6                          } // if (blink_cnt >= 200)
 362   5                      }
 363   4      
 364   4      #endif // æ§åˆ¶LEDæŒ‡ç¤ºç¯çš„é—ªçƒæ•ˆæœ
 365   4      
 366   4      #if 1 // é€€å‡ºledè®¾ç½®æ¨¡å¼çš„æ—¶é—´è®¡æ•°
 367   4      
 368   4                      // if (CUR_LED_MODE_INITIAL_DISCHARGE_GEAR == cur_led_mode ||
 369   4                      //     CUR_LED_MODE_DISCHARGE_RATE == cur_led_mode ||
 370   4                      //     CUR_LED_MODE_SETTING == cur_led_mode)
 371   4      
 372   4                      if (flag_is_in_setting_mode) // å¤„äºè®¾ç½®æ¨¡å¼ï¼Œå¼€å§‹ç´¯è®¡æ—¶é—´
 373   4                      {
 374   5                          // special_led_mode_times_cnt++;
 375   5                          // if (special_led_mode_times_cnt >= 5000)
 376   5                          // {
 377   5                          //     special_led_mode_times_cnt = 0;
 378   5                          //     flag_led_exit_setting_times_come = 1;
 379   5                          // }
 380   5                          led_setting_mode_exit_times_cnt++;
 381   5                          if (led_setting_mode_exit_times_cnt >= 5000)
 382   5                          {
 383   6                              led_setting_mode_exit_times_cnt = 0;
 384   6                              flag_led_setting_mode_exit_times_come = 1;
 385   6                          }
 386   5                      }
 387   4      
 388   4      #endif // é€€å‡ºledè®¾ç½®æ¨¡å¼çš„æ—¶é—´è®¡æ•°
 389   4      
 390   4                      {
 391   5                          static u8 cnt = 0;
 392   5                          // static u16 cnt = 0;
 393   5                          cnt++;
 394   5                          if (cnt >= 200)
 395   5                          // if (cnt >= 1000) // å»¶é•¿æ—¶é—´å¹¶ä¸ä¼šå½±å“ç”µæ± å¿«æ»¡ç”µåï¼Œè°ƒèŠ‚PWMçš„å¤§
             -å°ï¼Œè¿˜æ˜¯ä¼šè¿‡å†²ï¼Œç”µæµè¿‡å¤§
 396   5                          {
 397   6                              cnt = 0;
 398   6                              flag_is_charging_adjust_time_come = 1; // è°ƒèŠ‚å……ç”µç”µæµ/åŠŸç‡
 399   6                          }
 400   5                      }
 401   4      
 402   4      #if 1 // åœ¨æ¶“æµå……ç”µæ—¶ï¼Œè´Ÿè´£æ¯æ®µæ—¶é—´æ–­å¼€ä¸€ä¼šPWMè¾“å‡º
 403   4                      {
 404   5                          static u16 cnt = 0;
 405   5      
 406   5                          if (CUR_CHARGING_PWM_STATUS_LOW_FEQ == cur_charging_pwm_status)
 407   5                          {
 408   6                              // å¦‚æœåœ¨æ¶“æµå……ç”µ
 409   6                              cnt++;
 410   6      
 411   6                              if (cnt < 22000) // 22 s
 412   6                              {
 413   7                                  timer1_pwm_enable();
 414   7                                  // flag_is_tim_turn_off_pwm = 0;
 415   7                              }
 416   6                              else if (cnt <= (22000 + 60)) // 22s + 60ms
 417   6                              {
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 8   

 418   7                                  // ç´¯è®¡æ¶“æµå……ç”µ22såï¼Œå…³é—­æ§åˆ¶å……ç”µçš„PWMï¼Œä¹‹åå¯ä»¥åœ¨è¿™æœŸ
             -é—´æ£€æµ‹ç”µæ± æ˜¯å¦æ»¡ç”µ
 419   7                                  timer1_pwm_disable();
 420   7                                  // flag_is_tim_turn_off_pwm = 1;
 421   7                                  // cnt = 0;
 422   7                              }
 423   6                              else
 424   6                              {
 425   7                                  cnt = 0;
 426   7                              }
 427   6                          }
 428   5                          else
 429   5                          {
 430   6                              cnt = 0;
 431   6                          }
 432   5                      }
 433   4      #endif // åœ¨æ¶“æµå……ç”µæ—¶ï¼Œè´Ÿè´£æ¯æ®µæ—¶é—´æ–­å¼€ä¸€ä¼šPWMè¾“å‡º
 434   4      
 435   4      #if 1 // æ§åˆ¶ä¸»ç¯å…‰çš„é—ªçƒæ•ˆæœ
 436   4      
 437   4                      {
 438   5                          static u8 blink_cnt = 0; // è®°å½•é—ªçƒæ¬¡æ•°
 439   5                          static u16 time_cnt = 0; // æ§åˆ¶ç¯å…‰é—ªçƒçš„æ—¶é—´
 440   5      
 441   5                          if (flag_is_ctl_light_blink)
 442   5                          {
 443   6                              blink_cnt = light_ctl_blink_times;
 444   6                              time_cnt = 0;
 445   6                              // é—ªçƒå®Œæˆåï¼Œæ¸…é™¤æ ‡å¿—ä½
 446   6                              flag_is_ctl_light_blink = 0;
 447   6                          }
 448   5      
 449   5                          if (blink_cnt)
 450   5                          {
 451   6                              time_cnt++;
 452   6                              if (time_cnt < (u16)161) // 0 ~ 161 ms
 453   6                              {
 454   7                                  // å¦‚æœå½“å‰åœ¨æ”¾ç”µï¼š
 455   7                                  if (cur_led_mode != CUR_LED_MODE_OFF &&      /* æŒ‡ç¤ºç¯å¼€å¯ */
 456   7                                      cur_led_mode != CUR_LED_MODE_CHARGING && /* ä¸åœ¨å……ç”µ */
 457   7                                      (0 == flag_allow_light_in_setting_mode)) /* ä¸éœ€è¦é—ªå®Œç¯åå…³é—­ä¸»
             -ç¯å…‰ */
 458   7                                  // if (cur_led_mode != CUR_LED_MODE_OFF &&
 459   7                                  //     cur_led_mode != CUR_LED_MODE_CHARGING)
 460   7                                  {
 461   8                                      // LIGHT_OFF();
 462   8      
 463   8                                      LIGHT_ON();
 464   8                                  }
 465   7                                  else
 466   7                                  {
 467   8                                      // LIGHT_ON();
 468   8      
 469   8                                      LIGHT_OFF();
 470   8                                  }
 471   7                              }
 472   6                              else if (time_cnt < (u16)(161 * 2)) // 161 ~ 322 ms
 473   6                              {
 474   7                                  // å¦‚æœå½“å‰åœ¨æ”¾ç”µï¼š
 475   7                                  if (cur_led_mode != CUR_LED_MODE_OFF &&
 476   7                                      cur_led_mode != CUR_LED_MODE_CHARGING &&
 477   7                                      (0 == flag_allow_light_in_setting_mode))
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 9   

 478   7                                  // if (cur_led_mode != CUR_LED_MODE_OFF &&
 479   7                                  //     cur_led_mode != CUR_LED_MODE_CHARGING)
 480   7                                  {
 481   8                                      // LIGHT_ON();
 482   8      
 483   8                                      LIGHT_OFF();
 484   8                                  }
 485   7                                  else
 486   7                                  {
 487   8                                      // LIGHT_OFF();
 488   8      
 489   8                                      LIGHT_ON();
 490   8                                  }
 491   7                              }
 492   6                              else // è¶…è¿‡ 161 * 2msï¼Œæ¸…é™¤æ—¶é—´è®¡æ•°ï¼Œé—ªçƒæ¬¡æ•°å‡ä¸€ï¼Œè¡¨ç¤ºå®Œæˆä
             -¸€æ¬¡é—ªçƒ
 493   6                              {
 494   7                                  time_cnt = 0;
 495   7                                  blink_cnt--;
 496   7      
 497   7                                  // å¦‚æœå½“å‰åœ¨æ”¾ç”µï¼š
 498   7                                  if (cur_led_mode != CUR_LED_MODE_OFF &&
 499   7                                      cur_led_mode != CUR_LED_MODE_CHARGING &&
 500   7                                      (0 == flag_allow_light_in_setting_mode))
 501   7                                  // if (cur_led_mode != CUR_LED_MODE_OFF &&
 502   7                                  //     cur_led_mode != CUR_LED_MODE_CHARGING)
 503   7                                  {
 504   8                                      LIGHT_ON();
 505   8                                  }
 506   7                                  else
 507   7                                  {
 508   8                                      LIGHT_OFF();
 509   8                                  }
 510   7      
 511   7                                  // flag_is_need_to_exit_setting_mode_close_light = 0;
 512   7                              }
 513   6                          }
 514   5                      }
 515   4      
 516   4      #endif // æ§åˆ¶ä¸»ç¯å…‰çš„é—ªçƒæ•ˆæœ
 517   4      
 518   4      #if 1 // æ§åˆ¶é€€å‡ºæŒ‡ç¤ºç¯æŒ‡ç¤ºæ¨¡å¼
 519   4      
 520   4                      if (flag_is_in_struction_mode)
 521   4                      {
 522   5                          led_struction_mode_exit_times_cnt++;
 523   5                          if (led_struction_mode_exit_times_cnt >= 5000)
 524   5                          {
 525   6                              led_struction_mode_exit_times_cnt = 0;
 526   6                              // flag_is_in_struction_mode = 0;
 527   6                              flag_led_struction_mode_exit_times_come = 1;
 528   6                          }
 529   5                      }
 530   4      
 531   4      #endif // æ§åˆ¶é€€å‡ºæŒ‡ç¤ºç¯æŒ‡ç¤ºæ¨¡å¼
 532   4      
 533   4      #if 1 // æ§åˆ¶å®šæ—¶å…³æœº
 534   4      
 535   4                      {
 536   5                          static u32 cnt = 0;
 537   5      
 538   5                          if (flag_is_auto_shutdown_enable)
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 10  

 539   5                          {
 540   6                              cnt++; // ç´¯è®¡å®šæ—¶å…³æœºæ—¶é—´
 541   6                              if (cnt >= light_auto_shutdown_time_cnt)
 542   6                              {
 543   7                                  // è®©ä¸»å‡½æ•°å…³æœº
 544   7                                  flag_is_auto_shutdown_times_come = 1;
 545   7                              }
 546   6                          }
 547   5                          else
 548   5                          {
 549   6                              cnt = 0;
 550   6                              flag_is_auto_shutdown_times_come = 0;
 551   6                          }
 552   5                      }
 553   4      
 554   4      #endif // æ§åˆ¶å®šæ—¶å…³æœº
 555   4      
 556   4      #if 1
 557   4                      {
 558   5                          static u16 cnt = 0;
 559   5      
 560   5                          if (0 == flag_led_gear_update_times_come)
 561   5                          {
 562   6                              cnt++;
 563   6                              if (cnt >= 60000)
 564   6                              {
 565   7                                  cnt = 0;
 566   7                                  flag_led_gear_update_times_come = 1;
 567   7                              }
 568   6                          }
 569   5                      }
 570   4      #endif
 571   4      
 572   4                  } // if (cnt >= 10) // 10 * 100us == 1ms
 573   3              }
 574   2      
 575   2      #if 1 // æ”¾ç”µæ—¶é—´æ§åˆ¶
 576   2      
 577   2              // å¦‚æœä¸åœ¨å……ç”µï¼Œè®¾å¤‡æ²¡æœ‰å…³æœºï¼Œæ‰è¿›è¡Œæ”¾ç”µæ—¶é—´ç´¯è®¡
 578   2              {
 579   3                  static u16 cnt = 0;
 580   3                  if (CUR_CHARGE_PHASE_NONE == cur_charge_phase && /* å¦‚æœä¸åœ¨å……ç”µ */
 581   3                      cur_led_mode != CUR_LED_MODE_OFF)            /* å¦‚æœæŒ‡ç¤ºç¯æ²¡æœ‰å…³é—­ */
 582   3                  {
 583   4                      cnt++;
 584   4                      if (cnt >= 10000) // 10000 * 100usï¼Œ1s
 585   4                      {
 586   5                          cnt = 0;
 587   5                          // flag_is_light_adjust_time_come = 1;
 588   5      
 589   5                          if (light_adjust_time_cnt < 4294967295) // é˜²æ­¢è®¡æ•°æº¢å‡º
 590   5                          {
 591   6                              light_adjust_time_cnt++;
 592   6                          }
 593   5                      }
 594   4                  }
 595   3                  else
 596   3                  {
 597   4                      cnt = 0;
 598   4                  }
 599   3              }
 600   2      
C51 COMPILER V9.60.7.0   TIMER0                                                            08/08/2025 16:56:36 PAGE 11  

 601   2      #endif // æ”¾ç”µæ—¶é—´æ§åˆ¶
 602   2      
 603   2      #if 1 // ç¼“æ…¢è°ƒèŠ‚é©±åŠ¨ç¯å…‰çš„pwmå ç©ºæ¯”
 604   2      
 605   2              {
 606   3                  static u8 cnt = 0;
 607   3      
 608   3                  // ç›®å‰æ˜¯æ¯100usè°ƒèŠ‚ä¸€æ¬¡
 609   3      
 610   3                  if (flag_is_adjust_light_slowly)
 611   3                  {
 612   4                      cnt++;
 613   4                      if (cnt >= 100) // çœ‹èµ·æ¥è°ƒèŠ‚æ•ˆæœè¾ƒå¹³æ»‘
 614   4                      {
 615   5                          cnt = 0;
 616   5                          if (cur_light_pwm_duty_val > expect_light_pwm_duty_val)
 617   5                          {
 618   6                              // å¦‚æœè¦è°ƒå°ç¯å…‰çš„å ç©ºæ¯”
 619   6                              cur_light_pwm_duty_val--;
 620   6                          }
 621   5                          else if (cur_light_pwm_duty_val < expect_light_pwm_duty_val)
 622   5                          {
 623   6                              // å¦‚æœè¦è°ƒå¤§ç¯å…‰çš„å ç©ºæ¯”
 624   6                              cur_light_pwm_duty_val++;
 625   6                          }
 626   5                          else
 627   5                          {
 628   6                              // å¦‚æœç¯å…‰çš„å ç©ºæ¯”å·²ç»è¾¾åˆ°æœŸæœ›å€¼ï¼Œåˆ™å–æ¶ˆç¯å…‰çš„è°ƒå…‰
 629   6                              flag_is_adjust_light_slowly = 0; //
 630   6                          }
 631   5      
 632   5                          LIGHT_SET_PWM_DUTY(cur_light_pwm_duty_val);
 633   5                      }
 634   4                  }
 635   3                  // else
 636   3                  // {
 637   3                  //     cnt = 0;
 638   3                  // }
 639   3              }
 640   2      
 641   2      #endif // ç¼“æ…¢è°ƒèŠ‚é©±åŠ¨ç¯å…‰çš„pwmå ç©ºæ¯”
 642   2          }
 643   1      
 644   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 645   1          __IRQnIPnPop(TMR0_IRQn);
 646   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1435    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     25    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
